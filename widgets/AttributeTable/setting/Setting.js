//>>built
define("dojo/_base/declare dijit/_WidgetsInTemplateMixin jimu/BaseWidgetSetting jimu/dijit/SimpleTable dojo/_base/lang dojo/_base/html dojo/_base/array dojo/on dojo/Deferred dojo/promise/all dojo/query dijit/registry jimu/dijit/Popup jimu/dijit/Message jimu/dijit/CheckBox jimu/dijit/LoadingShelter ../utils".split(" "),function(x,y,z,t,e,q,h,m,u,v,r,w,A,n,B,C,g){return x([z,y],{baseClass:"jimu-widget-attributetable-setting",currentFieldTable:null,_allLayerFields:null,_layerInfos:null,_tableInfos:null,
_delayedLayerInfos:null,_delayedLayerInfosAfterInit:null,_unSpportQueryCampsite:null,startup:function(){this.inherited(arguments);this.config.layerInfos||(this.config.layerInfos=[]);this._allLayerFields=[];this._layerInfos=[];this._tableInfos=[];this._delayedLayerInfos=[];this._delayedLayerInfosAfterInit=[];this._unSpportQueryCampsite={};this.displayFieldsTable=new t({fields:[{name:"show",title:this.nls.show,width:"auto",type:"checkbox","class":"show"},{name:"label",title:this.nls.label,width:"60%",
type:"text"},{name:"url",title:this.nls.url,type:"text",hidden:!0},{name:"index",title:"index",type:"text",hidden:!0},{name:"sortField",title:this.nls.sortField,type:"dropdown",width:"130"},{name:"isDescending",title:"",width:"40",type:"checkbox","class":"sort-order"},{name:"actions",title:this.nls.actions,type:"actions",width:"20%",actions:["edit"],"class":"symbol"},{name:"showAttachments",title:"",type:"checkbox",hidden:!0}],selectable:!0,autoHeight:!1});this.displayFieldsTable.placeAt(this.tableLayerInfos);
q.setStyle(this.displayFieldsTable.domNode,{height:"100%"});this.shelter=new C({hidden:!0});this.shelter.placeAt(this.domNode.parentNode.parentNode||this.domNode);this.shelter.startup();this.shelter.show();g.readLayerInfosObj(this.map).then(e.hitch(this,function(a){this.own(a.on("layerInfosChanged",e.hitch(this,this.onLayerInfosChanged)));this.own(m(this.displayFieldsTable,"actions-edit",e.hitch(this,this.editFieldsClick)));this.own(m(this.displayFieldsTable,"row-click",e.hitch(this,this._verifiedOnShowClick)));
this.own(m(this.displayFieldsTable,"row-add",e.hitch(this,function(a){this._addTooltipToSortOrderNode(a)})));this.own(m(this.syncWithLayersCheck,"change",e.hitch(this,function(a){this._toggleTableShowOption(a)})));this.setConfig(this.config)}))},editFieldsClick:function(a){var b=r(".action-item-parent",a);if(b&&b.length)if(b=this.displayFieldsTable.getRowData(a),b.show){var d=parseInt(b.index,10);this.shelter.show();this._getLayerFields(d).then(e.hitch(this,function(c){this.openFieldsDialog(a,c,d)}),
e.hitch(this,function(a){console.error(a)})).always(e.hitch(this,function(){this.shelter.hide()}))}else var c=new n({message:this.nls.warning,buttons:[{label:this.nls.ok,onClick:e.hitch(this,function(){c.close()})}]})},_verifiedOnShowClick:function(a){var b=this.displayFieldsTable.getRowData(a),d=parseInt(b.index,10),c=null,c=this.config&&this.config.layerInfos&&0<this.config.layerInfos.length?this.config.layerInfos[d]:this._layerInfos[d],d=-1<this._unSpportQueryCampsite.layerNames.indexOf(c.name||
c.title);b.show&&d&&(new n({message:this.nls.unsupportQueryWarning}),b.show=!1,this.displayFieldsTable.editRow(a,b))},_getLayerFields:function(a){return this._layerInfos[a].getLayerObject().then(e.hitch(this,function(b){var d=this._allLayerFields[a];b=h.map(b.fields,function(a){return{name:a.name,alias:a.alias,show:!0}});b=g.arcade.appendArcadeExpressionsToFields(b,this._layerInfos[a]);g.merge(b,d,"name",function(a,b){e.mixin(a,b)});return b=g.syncOrderWith(b,d,"name")}))},_addTooltipToSortOrderNode:function(a){var b=
r(".sort-order .jimu-checkbox",a)[0];a=w.byNode(b);var d=this.nls,c=function(a){b.title=a?d.sortOrderTooltips.toAscending:d.sortOrderTooltips.toDescending};a&&(this.own(m(a,"change",c)),c(a.checked))},openFieldsDialog:function(a,b,d){var c=!1,f=this._layerInfos[d];(f=f&&f.layerObject)&&(c=f.hasAttachments&&f.objectIdField);var f=q.create("div"),k=this._createFieldsTable(b,d);q.place(k.domNode,f);var l=null;c&&(l=new B({label:this.nls.showAttachments,style:"margin-top:10px;"}),b=this.displayFieldsTable.getRowData(a),
l.setValue(b.showAttachments),l.placeAt(f));this.currentFieldTable=k;b=600;l&&(b=640);var p=new A({titleLabel:this.nls.configureLayerFields,width:640,maxHeight:b,autoHeight:!0,content:f,buttons:[{label:this.nls.ok,onClick:e.hitch(this,function(){this._allLayerFields[d]=k.getData();var c=l?l.getValue():!1;this.displayFieldsTable.editRow(a,{showAttachments:c});p.close();p=null})},{label:this.nls.cancel,classNames:["jimu-btn-vacation"],onClick:e.hitch(this,function(){p.close();p=null})}],onClose:function(){p=
null}});k.startup()},_createFieldsTable:function(a){for(var b=null,d={fields:[{name:"show",title:this.nls.fieldVisibility,type:"checkbox","class":"show",onChange:e.hitch(this,function(a){var c=b.getData();!h.some(c,e.hitch(this,function(a){return a.show}))&&(new n({message:this.nls.fieldCheckWarning}),c=b.getRowData(a))&&(c.show=!0,b.editRow(a,c))})},{name:"name",title:this.nls.fieldName,type:"text"},{name:"alias",title:this.nls.fieldAlias,editable:!0,type:"text"},{name:"actions",title:this.nls.fieldActions,
type:"actions",actions:["up","down"],"class":"symbol"}],selectable:!0,autoHeight:!1,style:{height:"300px",maxHeight:"300px"}},b=new t(d),d=0;d<a.length;d++)a[d].show=void 0===a[d].show?!0:!!a[d].show,b.addRow(a[d]);return b},setConfig:function(a){this.config=a;this.displayFieldsTable.clear();this._allLayerFields=[];this._processTableData().then(e.hitch(this,function(a){this._init(a);this.shelter.hide()}),e.hitch(this,function(a){new n({message:a.message||a})}))},onLayerInfosChanged:function(a,b,d){"added"===
b&&d&&a&&d.getSupportTableInfo().then(e.hitch(this,function(a){a.isSupportedLayer&&(this._layerInfos&&0===this._layerInfos.length?this._delayedLayerInfos.push(d):this._layerInfos&&0<this._layerInfos.length&&!this._getLayerInfoById(d.id)&&(this._delayedLayerInfosAfterInit.push(d),this._processDelayedLayerInfosAfterInit(this._delayedLayerInfosAfterInit)))}))},_processDelayedLayerInfosAfterInit:function(a){for(var b=this._layerInfos.length,d=[],c=0;c<a.length;c++){var f=g.getConfigInfoFromLayerInfo(a[c]),
k={label:f.name||f.title,url:f.layer.url,index:""+(b+c),isDescending:!0,show:f.show};this._allLayerFields.push(f.layer.fields);this._layerInfos.push(a[c]);d.push(this._prepareSortField(k,c))}v(d).then(e.hitch(this,function(a){for(var c=0;c<a.length;c++)this._addRowToDisplayFieldsTable(a[c])}),e.hitch(this,function(a){console.error(a)}))},_processDelayedLayerInfos:function(){0<this._delayedLayerInfos.length&&(h.forEach(this._delayedLayerInfos,e.hitch(this,function(a){this._getLayerInfoById(a.id)||
this._layerInfos.push(a)})),this._delayedLayerInfos=[])},_processTableData:function(){var a=new u;g.readConfigLayerInfosFromMap(this.map,!0,!0).then(e.hitch(this,function(b){this._layerInfos=b;this._processDelayedLayerInfos();g.readSupportTableInfoFromLayerInfos(this._layerInfos).then(e.hitch(this,function(d){this._tableInfos=d;this.config&&this.config.layerInfos&&0<this.config.layerInfos.length?(d=g.getConfigInfosFromLayerInfos(this._layerInfos),g.merge(d,this.config.layerInfos,"id",e.hitch(this,
function(a,b){var c=this._getLayerInfoById(a.id);a.layer.fields=g.arcade.appendArcadeExpressionsToFields(a.layer.fields,c);a.show=b.show;a.showAttachments=b.showAttachments;a.sortField=b.sortField;a.isDescending=b.isDescending;a.layer.url=b.layer.url;e.getObject("layer.fields.length",!1,a)&&e.getObject("layer.fields.length",!1,b)?(g.merge(a.layer.fields,b.layer.fields,"name",function(a,b){e.mixin(a,b)}),a.layer.fields=g.syncOrderWith(a.layer.fields,b.layer.fields,"name")):a.layer.fields=b.layer.fields})),
this.config.layerInfos=d,this._unSpportQueryCampsite.fromConfig=!0,this._unSpportQueryCampsite.layerNames=this._getUnsupportQueryLayerNames(this.config.layerInfos)):(this._unSpportQueryCampsite.fromConfig=!1,this._unSpportQueryCampsite.layerNames=this._getUnsupportQueryLayerNames(this._layerInfos),d=g.getConfigInfosFromLayerInfos(b),d=h.map(d,e.hitch(this,function(a){var b=e.getObject("layer.fields",!1,a),c=this._getLayerInfoById(a.id);b&&(b=g.arcade.appendArcadeExpressionsToFields(a.layer.fields,
c),a.layer.fields=b);return a})));a.resolve(d)}),function(b){console.error(b);a.reject(b)})}),e.hitch(this,function(b){console.error(b);a.reject(b)}));return a},_getUnsupportQueryLayerNames:function(a){var b=[];h.forEach(a,e.hitch(this,function(a){var c=this._getSupportTableInfoById(a.id);c&&!c.isSupportQuery&&b.push(a.name||a.title)}));return b},_init:function(a){for(var b=[],d=[],c=0;c<a.length;c++){var f=a[c].show&&this._getSupportTableInfoById(a[c].id).isSupportQuery,f={label:a[c].name||a[c].title,
url:a[c].layer.url,index:""+c,show:f,sorting:{fields:a[c].layer.fields,selectedField:a[c].sortField},isDescending:a[c].isDescending,showAttachments:!!a[c].showAttachments};this._allLayerFields.push(a[c].layer.fields);d.push(this._prepareSortField(f,c));this._unSpportQueryCampsite.fromConfig&&(f=(f=this._unSpportQueryCampsite.layerNames)&&-1<f.indexOf(a[c].name||a[c].title),a[c].show&&f&&b.push(a[c].name||a[c].title))}v(d).then(e.hitch(this,function(a){for(var b=0;b<a.length;b++)this._addRowToDisplayFieldsTable(a[b])}),
e.hitch(this,function(a){console.error(a)}));this._unSpportQueryCampsite.fromConfig&&0<b.length&&new n({message:this.nls.unsupportQueryLayers+"\x3cbr\x3e\x3cbr\x3e"+b.toString()});this.config.hideExportButton?this.exportcsv.uncheck():this.exportcsv.check();this.config.initiallyExpand?this.expand.check():this.expand.uncheck();this._canUseOpenAtStart()&&(this.openAtStart?this.expand.check():this.expand.uncheck(),this.expand.status=!1,q.addClass(this.expand.domNode,"disable-checkbox"));this.config.filterByMapExtent?
this.filterByMapExtent.check():this.filterByMapExtent.uncheck();this.config.allowTextSelection?this.textSelection.check():this.textSelection.uncheck();this.config.syncWithLayers?this.syncWithLayersCheck.check():this.syncWithLayersCheck.uncheck()},_addRowToDisplayFieldsTable:function(a){this.displayFieldsTable.addRow(a)},_prepareSortField:function(a,b){var d=new u;a.sorting&&a.sorting.fields?(a.sortField=this._prepareSortFieldOptions(a.sorting),d.resolve(a)):this._getLayerFields(b).then(e.hitch(this,
function(b){a.sorting?a.sorting.fields=b:a.sorting={fields:b};a.sortField=this._prepareSortFieldOptions(a.sorting);d.resolve(a)}),e.hitch(this,function(a){console.error(a);d.reject(a)}));return d},_prepareSortFieldOptions:function(a){if(a&&a.fields&&Array.isArray(a.fields))return h.map(a.fields,function(b){var d={value:b.name,label:b.alias};a.selectedField===b.name&&(d.selected=!0);0===b.name.indexOf("expression/")&&(d.disabled=!0);return d})},_canUseOpenAtStart:function(){return this.closeable||
!this.isOnScreen},_getLayerInfoById:function(a){for(var b=0,d=this._layerInfos.length;b<d;b++)if(this._layerInfos[b].id===a)return this._layerInfos[b]},_getSupportTableInfoById:function(a){for(var b=0,d=this._tableInfos.length;b<d;b++)if(this._tableInfos[b].id===a)return this._tableInfos[b]},getConfig:function(){var a=this.displayFieldsTable.getData(),b=[],d=a.length;if(this.config&&this.config.layerInfos&&0<this.config.layerInfos.length)h.forEach(a,e.hitch(this,function(c,d){c=this.config.layerInfos[d];
var e={};e.name=c.name||c.title;e.id=c.id;e.layer={};e.layer.url=a[d].url;e.layer.fields=this._allLayerFields[d];e.show=a[d].show;e.showAttachments=a[d].showAttachments;e.sortField=a[d].sortField;e.isDescending=a[d].isDescending;b.push(e)}));else for(var c=0;c<d;c++){var f={};f.name=this._layerInfos[c].name||this._layerInfos[c].title;f.id=this._layerInfos[c].id;f.layer={};f.layer.url=a[c].url;f.layer.fields=this._allLayerFields[c];f.show=a[c].show;f.showAttachments=a[c].showAttachments;f.sortField=
a[c].sortField;f.isDescending=a[c].isDescending;b.push(f)}this.config.layerInfos=b;this.config.hideExportButton=!this.exportcsv.getValue();this.config.filterByMapExtent=this.filterByMapExtent.getValue();this.config.allowTextSelection=this.textSelection.getValue();this.config.syncWithLayers=this.syncWithLayersCheck.getValue();this._canUseOpenAtStart()||(this.config.initiallyExpand=this.expand.getValue());return this.config},_toggleTableShowOption:function(a){this.displayFieldsTable&&r(".show .jimu-checkbox").forEach(function(b){w.byNode(b).setStatus(!a)})}})});