//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/html dojo/i18n!esri/nls/jsapi dojo/on dojo/query dojo/json dojo/Deferred dojo/aspect dojo/promise/all dijit/_WidgetsInTemplateMixin jimu/BaseWidget jimu/MapManager jimu/PanelManager jimu/LayerInfos/LayerInfos jimu/dijit/LoadingIndicator jimu/dijit/Popup jimu/utils jimu/portalUrlUtils jimu/SelectionManager jimu/Role esri/dijit/editing/Editor esri/dijit/editing/Util esri/dijit/Popup esri/dijit/editing/TemplatePicker esri/geometry/Extent esri/geometry/Point esri/renderers/jsonUtils esri/graphic esri/domUtils esri/tasks/query esri/tasks/QueryTask dijit/form/Button ./utils ./FilterEditor ./RelatedRecordsEditor".split(" "),
function(A,d,e,k,r,h,g,H,x,u,B,I,J,C,K,L,y,M,N,D,z,O,p,P,Q,R,E,S,T,F,v,U,V,G,t,W,X){var q=A([J,I],{name:"Edit",baseClass:"jimu-widget-edit",editor:null,_defaultStartStr:"",_defaultAddPointStr:"",_mapInfoStorage:null,_jimuLayerInfos:null,editPopup:null,_configEditor:null,_layerObjectsParaForTempaltePicker:null,_createOverDef:null,_releaseEventArrayAfterActive:null,_releaseEventArrayAfterClose:null,_releaseEventArrayAfterDestory:null,_canCreateLayersAreAllInvisibleFlag:null,_layerInfoParamArrayUseForRervertRenderre:null,
layerInfosParam:null,tableInfosParam:null,layerInfosParamClone:null,tableInfosParamClone:null,_tableInfoParamDef:null,_hasEditPrivilege:null,_panelManager:null,_originalCloasePanel:null,_changedTemplatesOfTemplatePicker:null,_releaseEventArrayAfterEditingRelatedGraphic:null,_isInEditingRelatedGraphicSession:null,_needToRequeryFeatureArray:null,_isEditableLayerStore:null,_layerInfosInConfig:null,_settingsParam:null,_temporaryDataForEditingRelatedGraphicSession:null,_layerInfosChangedWhenEditingSessionFlag:null,
postMixInProperties:function(){this.nls.done=window.jimuNls.common.done},startup:function(){this.inherited(arguments);this.editPopup=new q.EditPopup(null,k.create("div",{"class":"jimu-widget-edit-infoWindow"},null,this.map.root));this.loading=new y({hidden:!0});this.loading.placeAt(this.domNode);this._prepareCreating()},destroy:function(){this._worksAfterDestory();this.inherited(arguments)},onOpen:function(){"active"!==this.state&&this.widgetManager.activateWidget(this);this.editor&&this._settingsParam&&
(this._changeToServiceRenderer(this._settingsParam),this._onLayerInfosChanged());this._bindEventAfterOpen()},onClose:function(){this._revertToLayerRenderer();this._releaseEventAfterClose()},_prepareCreating:function(){this._init();this.loading.show();this._asyncPrepareDataAtStart().then(d.hitch(this,function(){var a;"BoxTheme"===this.appConfig.theme.name?(a=1050,this.loading.show()):a=1;setTimeout(d.hitch(this,function(){this.loading.hidden||this.loading.hide();this.widgetManager.activateWidget(this);
this._createEditor()}),a);this._getTableInfosParam().then(d.hitch(this,function(a){this.tableInfosParam=a;this.tableInfosParamClone=this._cloneLayerOrTableInfosParam(this.tableInfosParam);this._tableInfoParamDef.resolve()}));this.loading.hide()}),d.hitch(this,function(){this.loading.hide()}))},_init:function(){this._mapInfoStorage={resetInfoWindow:null,snappingTolerance:null,editorATIonLayerSelectionChange:null};this._editorMapClickHandlers=[];this._layerObjectsParaForTempaltePicker=[];this._configEditor=
d.clone(this.config.editor);this._releaseEventArrayAfterActive=[];this._releaseEventArrayAfterClose=[];this._releaseEventArrayAfterDestory=[];this._canCreateLayersAreAllInvisibleFlag=!1;this._layerInfoParamArrayUseForRervertRenderre=[];this._createOverDef=new x;this._tableInfoParamDef=new x;this._hasEditPrivilege=!0;this._panelManager=K.getInstance();this._changedTemplatesOfTemplatePicker=[];this._releaseEventArrayAfterEditingRelatedGraphic=[];this._isInEditingRelatedGraphicSession=!1;this._needToRequeryFeatureArray=
[];this._jimuLayerInfos=L.getInstanceSync(this.map,this.map.itemInfo);this._isEditableLayerStore={};this._layerInfosInConfig=this._getLayerInfosInConfig();this._temporaryDataForEditingRelatedGraphicSession={};this._layerInfosChangedWhenEditingSessionFlag=!1},_initEditPrivilege:function(a){this._hasEditPrivilege=!0;if(a){var b=new O({id:a.roleId?a.roleId:a.role,role:a.role});a.privileges&&b.setPrivileges(a.privileges);this._hasEditPrivilege=b.canEditFeatures()}return this._hasEditPrivilege},beginEditingByFeatures:function(a,
b){if(b){var c=null,f=a[0],l=f&&f.geometry||b._wabProperties&&b._wabProperties.popupInfo.originalFeature.geometry;l&&(c="point"===l.type?l:l.getExtent().getCenter());this._createOverDef.then(d.hitch(this,function(){"active"!==this.state&&this.widgetManager.activateWidget(this);e.forEach(this._jimuLayerInfos.getLayerInfoArray(),function(a){a.layerObject&&a.layerObject.clearSelection&&z.getInstance().clearSelection(a.layerObject)},this);if(f&&f.geometry)z.getInstance().setSelection(b,a).then(d.hitch(this,
function(){var a=b.getSelectedFeatures();this.editor._updatePopupButtons(a);this.editor._onEditFeature(a,c)}));else{this.editPopup.show(c);var l=d.getObject("_wabProperties.popupInfo.originalFeature",!1,b),n=d.getObject("_wabProperties.popupInfo.operationDataForListRelatedRecords",!1,b);this._createRelatedRecordsEditor(l).then(d.hitch(this,function(){!n&&f?this._relatedRecordsEditor.showInspector(this._relatedRecordsEditor._createOperationData(null,null,this._jimuLayerInfos.getTableInfoById(b.id),
f)):this._relatedRecordsEditor.showRelatedRecords(this._relatedRecordsEditor._createOperationData(n.feature,n.oriJimuLayerInfo,n.destJimuLayerInfo))}))}}))}},onActive:function(){this._hasEditPrivilege&&(this.disableWebMapPopup(),this._bindEventAfterActive(),this._configEditor.usingSaveButton&&(this._originalCloasePanel=this._panelManager.closePanel,this._panelManager.closePanel=this._wrapExistFunctionWithConfirmDialog(this._panelManager,this._originalCloasePanel)))},onDeActive:function(){this._hasEditPrivilege&&
(this.enableWebMapPopup(),this._releaseEventAfterActive(),this.editor&&this.editor.templatePicker&&this.editor.templatePicker.clearSelection(),this._configEditor.usingSaveButton&&(this._panelManager.closePanel=this._originalCloasePanel),e.forEach(this._needToRequeryFeatureArray,function(a){this._requeryFeature(a)},this),this._needToRequeryFeatureArray=[])},disableWebMapPopup:function(){var a=C.getInstance();a.disableWebMapPopup();this.map.infoWindow.hide();this.map.setInfoWindow(this.editPopup);this._enableMapClickHandler();
null===this._mapInfoStorage.resetInfoWindow&&(this._mapInfoStorage.resetInfoWindow=a.resetInfoWindow,this.own(h(this.map.infoWindow,"show",d.hitch(this,function(){window.appInfo.isRunInMobile&&(this.map.infoWindow.maximize(),setTimeout(d.hitch(this,function(){k.addClass(this.editPopup.domNode,"esriPopupMaximized")}),1))}))));a.resetInfoWindow=d.hitch(this,function(){});this.map.snappingManager&&void 0!==this._configEditor.snappingTolerance&&(this._mapInfoStorage.snappingTolerance=this.map.snappingManager.tolerance,
this.map.snappingManager.tolerance=this._configEditor.snappingTolerance)},enableWebMapPopup:function(){var a=C.getInstance(),b=a.getMapInfoWindow();this._mapInfoStorage.resetInfoWindow&&(this.map.setInfoWindow(b.bigScreen),a.isMobileInfoWindow=!1,a.resetInfoWindow=d.hitch(a,this._mapInfoStorage.resetInfoWindow),this._mapInfoStorage.resetInfoWindow=null,a.resetInfoWindow(),this._disableMapClickHandler(),this.editPopup.hide(),this._isEditingSession||this.editor._clearSelection(),a.enableWebMapPopup());
this.map.snappingManager&&null!==this._mapInfoStorage.snappingTolerance&&(this.map.snappingManager.tolerance=this._mapInfoStorage.snappingTolerance)},_enableMapClickHandler:function(){this.editor&&(this._editorMapClickHandlers.push(this.editor._mapClickHandler),this.editor._enableMapClickHandler(),this._editorMapClickHandlers.push(this.editor._mapClickHandler))},_disableMapClickHandler:function(){this.editor&&(this.editor._disableMapClickHandler(),e.forEach(this._editorMapClickHandlers,function(a){a&&
a.remove&&a.remove()},this),this._editorMapClickHandlers=[])},_cloneLayerOrTableInfosParam:function(a){var b=[];e.forEach(a,function(a){var c=a.featureLayer;a.featureLayer=null;var l=d.clone(a);l.featureLayer=c;a.featureLayer=c;b.push(l)},this);return b},_isTemporaryFeatureForAddOnlyMode:function(a){a=a.getLayer();this._jimuLayerInfos.getLayerOrTableInfoById(a&&a.id)},_getDefaultFieldInfos:function(a){(a=t.getFieldInfosFromWebmap(a,this._jimuLayerInfos))&&(a=e.filter(a,function(a){return a.visible||
a.isEditable}));return a},_getDefaultLayerInfoById:function(a){var b={featureLayer:{}};b.featureLayer.id=a;b.allowCreate=!0;b.allowDelete=!0;b.disableGeometryUpdate=!1;(a=this._getDefaultFieldInfos(a))&&0<a.length&&(b.fieldInfos=a);return b},_getDefaultTableInfos:function(){var a=[],b=this._jimuLayerInfos.getTableInfoArray();e.forEach(b,function(b){b=this._getDefaultLayerInfoById(b.id);a.push(b)},this);return a},_getDefaultLayerInfos:function(){for(var a=[],b=this.map.graphicsLayerIds.length-1;0<=
b;b--){var c=this.map.getLayer(this.map.graphicsLayerIds[b]);"Feature Layer"===c.type&&c.url&&(c=this._getDefaultLayerInfoById(c.id),a.push(c))}return a},_asyncPrepareDataAtStart:function(){var a=[];e.forEach(this._layerInfosInConfig,function(b){var c=this._jimuLayerInfos.getLayerInfoByTopLayerId(b.featureLayer.id);c&&(c=c.isEditable(),c._layerInfoInConfig=b,a.push(c))},this);return B(a).then(d.hitch(this,function(b){e.forEach(b,function(b,f){f=a[f]._layerInfoInConfig;this._isEditableLayerStore[f&&
f.featureLayer&&f.featureLayer.id]=b},this)}))},_getLayerInfosInConfig:function(){return this._configEditor.honorSettingOfWebmap?this._getDefaultLayerInfos():this._configEditor.layerInfos?0<this._configEditor.layerInfos.length?this._converConfiguredLayerInfos(this._configEditor.layerInfos):this._getDefaultLayerInfos():[]},_converConfiguredLayerInfos:function(a){function b(a,b){for(var c=null,f=0;f<a.graphicsLayerIds.length;f++){var d=a.getLayer(a.graphicsLayerIds[f]);if(d&&d.url&&D.removeProtocol(d.url.toLowerCase())===
D.removeProtocol(b.toLowerCase())){c=d;break}}return c}e.forEach(a,function(a){if(!a.featureLayer.id&&a.featureLayer.url){var c=b(this.map,a.featureLayer.url);c&&(a.featureLayer.id=c.id)}var d=[],m=t.getFieldInfosFromWebmap(a.featureLayer.id,this._jimuLayerInfos);e.forEach(a.fieldInfos,function(a){var b;b=null;if(m)for(var c=0;c<m.length;c++)if(a.fieldName===m[c].fieldName){m[c].label=a.label;m[c].isEditableSettingInWebmap=m[c].isEditable;m[c].isEditable=a.isEditable;b=m[c];break}if(void 0===a.visible)b?
(b.isEditable||b.isEditableSettingInWebmap||b.visible)&&d.push(b):d.push(a);else if(a.visible||a.isEditable)b?d.push(b):d.push(a)},this);0!==d.length&&(a.fieldInfos=d)},this);return a},_getLayerInfoOrTableInfoParamById:function(a){var b=null;e.some(this.layerInfosParam.concat(this.tableInfosParam),function(c){if(c.featureLayer.id===a)return b=c,!0});return b},_getLayerInfosParam:function(){var a=[];e.forEach(this._layerInfosInConfig,function(b){var c=b.featureLayer.id,f=this.map.getLayer(c);f&&this._isEditableLayerStore[c]&&
(b.featureLayer=f,a.push(b))},this);this.layerInfosParam=a;this.layerInfosParamClone=this._cloneLayerOrTableInfosParam(this.layerInfosParam);return a},_setTemplatePickerLayerObjectsParam:function(a){a&&(this._layerObjectsParaForTempaltePicker=a)},_obtainTemplatePickerLayerObjectsParam:function(a){this._layerObjectsParaForTempaltePicker=[];var b=[];e.forEach(this._jimuLayerInfos.getLayerInfoArray(),function(c){e.some(a,function(a){return a.featureLayer&&c.id===a.featureLayer.id?(b.push(a),!0):!1},
this)},this);e.forEach(b,function(a){if(a.featureLayer){var b=this._jimuLayerInfos.getLayerInfoByTopLayerId(a.featureLayer.id);b&&b.isShowInMap()&&b.isInScale()&&t.getEditCapabilities(b.layerObject,a).canCreate&&this._layerObjectsParaForTempaltePicker.push(a.featureLayer);!this._canCreateLayersAreAllInvisibleFlag&&this._isEditableLayerStore[a.featureLayer.id]&&t.getEditCapabilities(b.layerObject,a).canCreate&&!a.featureLayer.visible&&(this._canCreateLayersAreAllInvisibleFlag=!0)}},this);return this._layerObjectsParaForTempaltePicker},
_getTemplatePicker:function(a){a=this._obtainTemplatePickerLayerObjectsParam(a);a=new R({featureLayers:a,grouping:!0,rows:"auto",columns:"auto",style:(this._configEditor.toolbarVisible?"":"bottom: 0px")+";"+(this._configEditor.useFilterEdit?"top: "+q.TOP_WITH_TEMPLATE_FILTER:"top: "+q.TOP)},k.create("div",{},this.domNode));a.startup();return a},_getSettingsParam:function(){var a={map:this.map,createOptions:{polygonDrawTools:[p.CREATE_TOOL_ARROW,p.CREATE_TOOL_AUTOCOMPLETE,p.CREATE_TOOL_CIRCLE,p.CREATE_TOOL_ELLIPSE,
p.CREATE_TOOL_RECTANGLE,p.CREATE_TOOL_TRIANGLE,p.CREATE_TOOL_POLYGON,p.CREATE_TOOL_FREEHAND_POLYGON],polylineDrawTools:[p.CREATE_TOOL_POLYLINE,p.CREATE_TOOL_FREEHAND_POLYLINE]}},b;for(b in this._configEditor)a[b]=this._configEditor[b];a.layerInfos=this._getLayerInfosParam();a.templatePicker=this._getTemplatePicker(a.layerInfos);void 0!==this._configEditor.popupTolerance&&(a.singleSelectionTolerance=this._configEditor.popupTolerance);return a},_createEditor:function(){var a={settings:this._getSettingsParam()};
this._settingsParam=a.settings;this._worksBeforeCreate(a.settings);this.editor=new p(a,k.create("div",{},this.domNode));this.editor.startup();this._worksAfterCreate(a.settings)},_addButtonToInspector:function(){var a=new G({label:this.nls.close,"class":" atiButton close-button"},k.create("div"));k.place(a.domNode,this.editor.attributeInspector.deleteBtn.domNode,"before");this.own(h(a,"click",d.hitch(this,function(){this.editPopup.hide()})));if(this._configEditor.usingSaveButton){a=new G({label:window.jimuNls.common.save,
"class":" atiButton save-button disable"},k.create("div"));k.place(a.domNode,this.editor.attributeInspector.deleteBtn.domNode,"after");var b=this.editor.attributeInspector;this.own(h(a,"click",d.hitch(this,function(){if(this._isEditingSession){var a=b._currentFeature&&b._currentFeature._wabSetTemporaryAttributes,c=b._currentFeature,e=c&&c.getLayer(),n=new F(d.clone(c.toJson()));if(e){for(var w in a)a.hasOwnProperty(w)&&"function"!==typeof a[w]&&(c.attributes[w]=a[w]);a=new F;a.setAttributes(c.attributes);
this.editor._applyEdits([{layer:e,updates:[a],preUpdates:[n]}],d.hitch(this,function(){this._stopEditingSession()}),!0)}}})));var c=this;b.onAttributeChange=d.hitch(b,function(a,d,e){c._startEditingSession();b._currentFeature._wabSetTemporaryAttributes[d]=e});this.editPopup.hideWidthConfirmDialog=this._wrapExistFunctionWithConfirmDialog(this.editPopup,this.editPopup.hideWidthConfirmDialog);this.editor.attributeInspector.next=this._wrapExistFunctionWithConfirmDialog(this.editor.attributeInspector,
this.editor.attributeInspector.next);this.editor.attributeInspector.previous=this._wrapExistFunctionWithConfirmDialog(this.editor.attributeInspector,this.editor.attributeInspector.previous);this.own(u.before(this.editor,"_deleteFeature",d.hitch(this,function(){this._configEditor.usingSaveButton&&this._stopEditingSession()})))}},_startEditingSession:function(){var a=this.editor.attributeInspector;a._currentFeature&&!a._currentFeature._wabSetTemporaryAttributes&&(a._currentFeature._wabSetTemporaryAttributes=
{});this._isEditingSession||(this._isEditingSession=!0,this._disableMapClickHandler(),this._temporatyMapClickHandle=h(this.map,"click",d.hitch(this,function(){this.editPopup.hide("clear-selection")})),window.onbeforeunload=d.hitch(this,function(){return""}));g(".atiButton.save-button",this.editPopup.domNode).removeClass("disable")},_stopEditingSession:function(){if(this.editor){var a=this.editor.attributeInspector;a._currentFeature&&a._currentFeature._wabSetTemporaryAttributes&&(a._currentFeature._wabSetTemporaryAttributes=
null);this._isEditingSession&&(this._isEditingSession=!1,"active"===this.state?this._enableMapClickHandler():(this.editor._clearSelection(),this.editPopup.hide()),this._temporatyMapClickHandle&&this._temporatyMapClickHandle.remove(),window.onbeforeunload=null);g(".atiButton.save-button",this.editPopup.domNode).addClass("disable")}},_wrapExistFunctionWithConfirmDialog:function(a,b){return d.hitch(this,function(c){if(this._isEditingSession){if(!this.editPopup.jimuPopup){var f=arguments;this._popupConfirmDialog(d.hitch(this,
function(){b.apply(a,f);"clear-selection"===c&&this.editor._clearSelection()}),null)}}else b.apply(a,arguments)})},_popupConfirmDialog:function(a,b){var c=new x,f=g(".esriPopupWrapper",this.editPopup.domNode)[0];this._isEditingSession&&!this.editPopup.jimuPopup&&f?this.editPopup.jimuPopup=new M({content:window.jimuNls.popup.leaveConfirm,container:f,width:400,height:175,buttons:[{label:window.jimuNls.common.leave,onClick:d.hitch(this,function(){this.editPopup.jimuPopup.close();this.editPopup.jimuPopup=
null;this._stopEditingSession();this._refreshAttributeInspector();a&&a();c.resolve(!0)})},{label:window.jimuNls.common.stay,classNames:["jimu-btn-cancle"],onClick:d.hitch(this,function(){this.editPopup.jimuPopup.close();this.editPopup.jimuPopup=null;b&&b();c.resolve(!1)})}]}):c.resolve(!0);return c},_addFilterEditor:function(a){this._configEditor.useFilterEdit&&(this._filterEditor=new W({_settings:a,_editWidget:this},k.create("div",{},this.domNode)))},_worksBeforeCreate:function(a){var b="\x3cbr/\x3e("+
this.nls.pressStr+"\x3cb\x3e"+this.nls.ctrlStr+"\x3c/b\x3e "+this.nls.snapStr+")";this._defaultStartStr=r.toolbars.draw.start;this._defaultAddPointStr=r.toolbars.draw.addPoint;r.toolbars.draw.start+=b;r.toolbars.draw.addPoint+=b;this._changeToServiceRenderer(a)},_worksAfterCreate:function(a){this._addButtonToInspector();this._configEditor.toolbarVisible&&this._disableDeleteBtnInToolbar();this.editPopup.resize(500,251);this.editor.templatePicker.update(!0);this._addFilterEditor(a);this._bindEventsAfterCreate(a);
this._changeMessageForTemplatePicker();this.ATILoading=(new y({hidden:!0})).placeAt(this.editor.attributeInspector.domNode);this.editor.own(u.before(this.editor._selectionHelper,"selectFeatures",d.hitch(this.editor._selectionHelper,function(a,b,c,d){return[e.filter(a,function(a){if(!0===a.visible&&!0===a._isMapAtVisibleScale())return!0}),b,c,d]})));var b=a=null,c=P.getSelection(this._settingsParam.layers);c&&c.length&&(a=c[0],b=a.getLayer());b&&z.getInstance().addFeaturesToSelection(b,[a]);this._createOverDef.resolve()},
_worksAfterDestory:function(){this._stopEditingRelatedGraphic();r.toolbars.draw.start=this._defaultStartStr;r.toolbars.draw.addPoint=this._defaultAddPointStr;this._filterEditor&&this._filterEditor.destroy();this._releaseEventAfterDestory();this.editor&&this.editor.destroy();this.editor=null},_bindEventsAfterCreate:function(a){this.own(h(this.editor.editToolbar,"graphic-move-stop",d.hitch(this,this._onGraphicMoveStop)));this.own(h(this.editor.attributeInspector,"next",d.hitch(this,this._onNextOfEditorATI)));
var b=h(this.editPopup,"show",d.hitch(this,this._onEditorPopupShow));this._releaseEventArrayAfterDestory.push(b);b=h(this.editPopup,"hide",d.hitch(this,this._onEditorPopupHide));this._releaseEventArrayAfterDestory.push(b);e.forEach(a.layerInfos,function(a){b=h(a.featureLayer,"selection-complete",d.hitch(this,this._onLayerSelectionChange));this._releaseEventArrayAfterDestory.push(b)},this);b=u.before(this.editor.templatePicker.grid,"onRowClick",d.hitch(this,function(){"active"!==this.state&&this.widgetManager.activateWidget(this)}));
this._releaseEventArrayAfterDestory.push(b);a=h(this.editor.templatePicker,"selection-change",d.hitch(this,function(){this.editor.templatePicker&&!this.editor.templatePicker.getSelected()&&this._layerInfosChangedWhenEditingSessionFlag&&(this._layerInfosChangedWhenEditingSessionFlag=!1,this._isInEditingRelatedGraphicSession||this._onLayerInfosChanged())}));this._releaseEventArrayAfterDestory.push(a)},_releaseEventAfterDestory:function(){e.forEach(this._releaseEventArrayAfterDestory,function(a){a.remove()},
this);this._releaseEventArrayAfterDestory=[]},_bindEventAfterActive:function(){var a=u.before(this.map,"onClick",d.hitch(this,this._beforeMapClick));this._releaseEventArrayAfterActive.push(a)},_releaseEventAfterActive:function(){e.forEach(this._releaseEventArrayAfterActive,function(a){a.remove()},this);this._releaseEventArrayAfterActive=[]},_bindEventAfterOpen:function(){var a=h(this._jimuLayerInfos,"layerInfosChanged",d.hitch(this,this._onLayerInfosChanged));this._releaseEventArrayAfterClose.push(a);
a=h(this._jimuLayerInfos,"layerInfosIsShowInMapChanged",d.hitch(this,this._onLayerInfosChanged));this._releaseEventArrayAfterClose.push(a);a=h(this._jimuLayerInfos,"layerInfosReorder",d.hitch(this,this._onLayerInfosChanged));this._releaseEventArrayAfterClose.push(a);a=h(this.map,"zoom-end",d.hitch(this,this._onLayerInfosChanged));this._releaseEventArrayAfterClose.push(a)},_releaseEventAfterClose:function(){e.forEach(this._releaseEventArrayAfterClose,function(a){a.remove()},this);this._releaseEventArrayAfterClose=
[]},_onLayerInfosChanged:function(){if(this.editor.templatePicker&&this.editor.templatePicker.getSelected())this._layerInfosChangedWhenEditingSessionFlag=!0;else{var a=[];this._isInEditingRelatedGraphicSession?this._startEditingRelatedGraphic(this._temporaryDataForEditingRelatedGraphicSession.currentOperationData,this._temporaryDataForEditingRelatedGraphicSession.currentIntegrityField,!0,!0):(a=this._obtainTemplatePickerLayerObjectsParam(this._settingsParam.layerInfos),this._update(a))}},_changeToServiceRenderer:function(a){e.forEach(a.layerInfos,
function(a){if(a.featureLayer._json){var b=a.featureLayer.renderer,d=b.toJson(),e=H.parse(a.featureLayer._json).drawingInfo.renderer;N.isEqual(d,e)||(a._layerRenderer=b,this._layerInfoParamArrayUseForRervertRenderre.push(a),a.featureLayer.setRenderer(T.fromJson(e)),a.featureLayer.redraw())}},this)},_revertToLayerRenderer:function(){e.forEach(this._layerInfoParamArrayUseForRervertRenderre,function(a){a._layerRenderer&&(a.featureLayer.setRenderer(a._layerRenderer),a.featureLayer.redraw())},this);this._layerInfoParamArrayUseForRervertRenderre=
[]},_requeryFeature:function(a,b){var c=a&&a.getLayer&&a.getLayer();if(c&&!this._isTemporaryFeatureForAddOnlyMode(a)){var f=new V(c.url),e=new U,c=a.attributes[c.objectIdField];e.objectIds=[c];e.outSpatialReference=this.map.spatialReference;e.returnGeometry=!1;e.outFields=["*"];b&&this.ATILoading.show();c&&f.execute(e).then(d.hitch(this,function(c){if(c&&c.features&&c.features[0]){c=c.features[0];for(var d in a.attributes)a.attributes.hasOwnProperty(d)&&"function"!==typeof a.attributes[d]&&a.attributes[d]!==
c.attributes[d]&&(a.attributes[d]=c.attributes[d]);this._refreshAttributeInspector()}b&&this.ATILoading.hide()}),d.hitch(this,function(){b&&this.ATILoading.hide()}))}},_pushToNeedRequeryFeatureArray:function(a){var b=a&&a.getLayer&&a.getLayer();if(b){var c=a.attributes[b.objectIdField];e.some(this._needToRequeryFeatureArray,function(a){var d=a.getLayer();a=a.attributes[d.objectIdField];if(b.id===d.id&&c===a)return!0},this)||this._needToRequeryFeatureArray.push(a)}},_updateSelectedFeature:function(a){a&&
(a.getLayer().applyEdits(null,[a]),this.editor._clearSelection())},_autoApplyEditWhenGeometryIsModified:function(){var a=this.editor.editToolbar.getCurrentState(),b=a&&a.graphic;this._configEditor.autoApplyEditWhenGeometryIsMoved&&(this._checkStickyMoveTolerance()?this._updateSelectedFeature(b):a.isModified&&"point"!==b.geometry.type&&this._updateSelectedFeature(b))},_checkStickyMoveTolerance:function(){var a=!0,b=this.editor.editToolbar.getCurrentState();if(b=b&&b.graphic)this._isOutStickyMoveToleranceCheckedByMoveTrack(b)||
(this._revertGraphicPosition(b),a=!1),delete b._moveTrack,delete b._originalGeometryAtMoveStart;return a},_isOutStickyMoveToleranceCheckedByOriginalGeometry:function(a){var b,c,d,e=!0;"point"===a.geometry.type?(b=a._originalGeometryAtMoveStart,c=a.geometry):a.geometry.getExtent&&a._originalGeometryAtMoveStart.getExtent&&(b=a._originalGeometryAtMoveStart.getExtent().getCenter(),c=a.geometry.getExtent().getCenter());this._configEditor.stickyMoveTolerance&&b&&c&&(d=this.map.extent.getWidth(),d/=this.map.width,
d*=this._configEditor.stickyMoveTolerance,a=new E(0,0,d,d,a.spatialReference),a=a.centerAt(b),a.contains(c)&&(e=!1));return e},_isOutStickyMoveToleranceCheckedByMoveTrack:function(a){var b=!0,c;c=a._moveTrack;var d;c&&(d=new S(c.x,c.y,a.spatialReference));this._configEditor.stickyMoveTolerance&&d&&(c=this.map.extent.getWidth(),c/=this.map.width,c*=this._configEditor.stickyMoveTolerance,a=new E(-c/2,-c/2,c,c,a.spatialReference),a.contains(d)&&(b=!1));return b},_revertGraphicPosition:function(a){var b=
a._moveTrack;if(b){switch(a.geometry.type){case "point":a.geometry.x-=b.x;a.geometry.y+=b.y;break;case "polygon":e.forEach(a.geometry.rings,function(a){e.forEach(a,function(a){a[0]-=b.x;a[1]+=b.y})});break;case "polyline":e.forEach(a.geometry.paths,function(a){e.forEach(a,function(a){a[0]-=b.x;a[1]+=b.y})});break;case "multiPoint":e.forEach(a.geometry.points,function(a){a[0]-=b.x;a[1]+=b.y});break;default:return}this._configEditor.autoApplyEditWhenGeometryIsMoved||e.forEach(this.editor.editToolbar._getAffectedTools("MOVE"),
function(a){a.suspend()},this);"point"===a.geometry.type&&this.editor._clearSelection();a.draw()}},_recordsSelectedFeatureInfoWhenMoveStart:function(a){(a=a&&a.graphic)&&a.geometry&&(a._originalGeometryAtMoveStart=d.clone(a.geometry))},_recordsSelectedFeatureInfoWhenMoveStop:function(a){var b=a&&a.graphic;a=a&&a.transform;var c=this.map.extent.getWidth()/this.map.width;b&&a&&(b._moveTrack||(b._moveTrack={x:0,y:0}),b._moveTrack.x+=a.dx*c,b._moveTrack.y+=a.dy*c)},_getSelectionFeatuers:function(){var a=
[];e.forEach(this.layerInfosParam,function(b){b=b.featureLayer.getSelectedFeatures();a=a.concat(b)});return a},_getEditCapabilitiesByFeature:function(a){var b={},c=a&&a.getLayer&&a.getLayer();if(c&&c.isEditable&&c.isEditable()){var d=this._getLayerInfoOrTableInfoParamById(c.id);c&&(b=t.getEditCapabilities(c,d,{feature:a}))}return b},_createRelatedRecordsEditor:function(a){if(a&&!this._isTemporaryFeatureForAddOnlyMode(a)){var b=k.create("div",{style:"position: relative"});k.place(b,this.editor.attributeInspector.domNode,
"after");var c=(new y({})).placeAt(b);return this._tableInfoParamDef.then(d.hitch(this,function(){try{this._relatedRecordsEditor&&(this._relatedRecordsEditor.destroy(),this._relatedRecordsEditor=null),this._relatedRecordsEditor=new X({originalFeature:a,editorATI:this.editor.attributeInspector,tableInfosParam:this.layerInfosParamClone.concat(this.tableInfosParamClone),nls:d.mixin(d.clone(this.nls),window.jimuNls.common),_editWidget:this}),c.destroy()}catch(f){console.warn(f.message),c.destroy(),this._enableToAnswerEventForEditorATI()}}))}},
_disableToAnswerEventForEditorATI:function(){this._mapInfoStorage.editorATIonLayerSelectionChange||(this._mapInfoStorage.editorATIonLayerSelectionChange=this.editor.attributeInspector.onLayerSelectionChange,this.editor.attributeInspector.onLayerSelectionChange=d.hitch(this,function(){}));this._mapInfoStorage.editorATIonLayerSelectionClear||(this._mapInfoStorage.editorATIonLayerSelectionClear=this.editor.attributeInspector.onLayerSelectionClear,this.editor.attributeInspector.onLayerSelectionClear=
d.hitch(this,function(){}))},_enableToAnswerEventForEditorATI:function(){this._mapInfoStorage.editorATIonLayerSelectionChange&&(this.editor.attributeInspector.onLayerSelectionChange=d.hitch(this.editor.attributeInspector,this._mapInfoStorage.editorATIonLayerSelectionChange),this._mapInfoStorage.editorATIonLayerSelectionChange=null);this._mapInfoStorage.editorATIonLayerSelectionClear&&(this.editor.attributeInspector.onLayerSelectionClear=d.hitch(this.editor.attributeInspector,this._mapInfoStorage.editorATIonLayerSelectionClear),
this._mapInfoStorage.editorATIonLayerSelectionClear=null)},_getTableInfosParam:function(){var a,b=[],c=[];a=this._configEditor.honorSettingOfWebmap?this._getDefaultTableInfos():this._configEditor.tableInfos?0<this._configEditor.tableInfos.length?this._converConfiguredLayerInfos(this._configEditor.tableInfos):this._getDefaultTableInfos():[];e.forEach(a,function(a){var c=this._jimuLayerInfos.getTableInfoById(a.featureLayer.id);c&&(a.jimuTableInfo=c,b.push(c.getLayerObject()))},this);return B(b).then(d.hitch(this,
function(){e.forEach(a,function(a){if(a.jimuTableInfo){var b=a.jimuTableInfo.layerObject,d=a.jimuTableInfo.getCapabilitiesOfWebMap(),d=d&&-1===d.toLowerCase().indexOf("editing")?!1:!0;b&&b.visible&&b.isEditable&&b.isEditable()&&d&&(a.featureLayer=a.jimuTableInfo.layerObject,delete a.jimuTableInfo,c.push(a))}},this);return c}))},_startEditingRelatedGraphic:function(a,b,c,f){this._stopEditingRelatedGraphic();this._temporaryDataForEditingRelatedGraphicSession.currentOperationData=a;this._temporaryDataForEditingRelatedGraphicSession.currentIntegrityField=
b;this._isInEditingRelatedGraphicSession=!0;var l=a.destJimuLayerInfo,m=a.destJimuLayerInfo.layerObject;c||(this.editPopup.hide(),this.editor._clearSelection());k.removeClass(this.editRelatedGraphicPart,"disable");k.setStyle(this.editor.templatePicker.domNode,"top",this._configEditor.useFilterEdit?q.TOP_WITH_TEMPLATE_FILTER_AND_EDIT_RG:q.TOP_WITH_EDIT_RG);c=[];l.isShowInMap()&&l.isInScale()&&(c=[m]);this._setTemplatePickerLayerObjectsParam(c);this._update(c);this._filterEditor&&(this._filterEditor.selectLayerFilterByValue(m.id),
this._filterEditor.disableLayerFilter());l=b.hasRelationshipTable?h(m,"edits-complete",d.hitch(this,function(b){if(b&&b.adds&&1===b.adds.length){var c=b.adds[0],d=null;e.some(m.graphics,function(a){if(a.attributes[m.objectIdField]===c.objectId)return d=a,!0});d&&this._relatedRecordsEditor._addNewRelationshipReocrd(d,a)}})):h(this.editor.templatePicker,"selection-change",d.hitch(this,function(){var a=this.editor.templatePicker.getSelected();(a=a&&a.template)&&!d.getObject("_wabProperties.originalInterityField",
!1,a)&&a.prototype&&a.prototype.attributes&&(d.setObject("_wabProperties.originalInterityField.key",b.key,a),d.setObject("_wabProperties.originalInterityField.value",a.prototype.attributes[b.key],a),a.prototype.attributes[b.key]=b.value,this._changedTemplatesOfTemplatePicker.push(a))}));this._releaseEventArrayAfterEditingRelatedGraphic.push(l);if(!f){f=g(".itemSymbol",this.editor.templatePicker.domNode);var n;f&&0<f.length&&(n=(n=f[0])&&n.parentNode&&n.parentNode.parentNode);n&&this.editor.templatePicker._rowClicked({cellNode:n,
rowIndex:1,cellIndex:0})}},_stopEditingRelatedGraphic:function(){this._isInEditingRelatedGraphicSession&&(this._temporaryDataForEditingRelatedGraphicSession={},k.addClass(this.editRelatedGraphicPart,"disable"),k.setStyle(this.editor.templatePicker.domNode,"top",this._configEditor.useFilterEdit?q.TOP_WITH_TEMPLATE_FILTER:q.TOP),e.forEach(this._releaseEventArrayAfterEditingRelatedGraphic,function(a){a&&a.remove&&a.remove()},this),this._releaseEventArrayAfterEditingRelatedGraphic=[],e.forEach(this._changedTemplatesOfTemplatePicker,
function(a){if(d.getObject("_wabProperties.originalInterityField",!1,a)&&a.prototype&&a.prototype.attributes){var b=d.getObject("_wabProperties.originalInterityField.key",!1,a),c=d.getObject("_wabProperties.originalInterityField.value",!1,a);a.prototype.attributes[b]=c}},this),this._changedTemplatesOfTemplatePicker=[],this._filterEditor&&this._filterEditor.enableLayerFilter(),this.editor.templatePicker.clearSelection(),this._isInEditingRelatedGraphicSession=!1,this._onLayerInfosChanged())},_changeMessageForTemplatePicker:function(){if(this.editor&&
0===this.editor.templatePicker.featureLayers.length){var a=g("[class~\x3ddojoxGridMasterMessages]",this.editor.templatePicker.domNode);a&&a[0]&&(a[0].innerHTML=this._canCreateLayersAreAllInvisibleFlag?this.nls.noCanCreateLayerAreCurrentlyVisible:window.jimuNls.noEditableLayers)}},_refreshAttributeInspector:function(){this.editor&&this.editor.attributeInspector&&this.editor.attributeInspector.refresh();this.editPopup.isShowing&&this._updateDeleteButtonInPopup(this.editor&&this.editor.attributeInspector&&
this.editor.attributeInspector._currentFeature)},_updateOperationalButtons:function(a){this._updateDeleteButtonInPopup(a);this._updateGeometryOperationButtons(a)},_updateDeleteButtonInPopup:function(a){this._getEditCapabilitiesByFeature(a).canDelete?this._enableDeleBtnInPopup():this._disableDeleteBtnInPopup()},_disableDeleteBtnInToolbar:function(){this._configEditor.toolbarVisible&&g("[class~\x3ddeleteFeatureIcon]",this.editor.domNode).style("display","none")},_enableDeleBtnInToolbar:function(){this._configEditor.toolbarVisible&&
g("[class~\x3ddeleteFeatureIcon]",this.editor.domNode).style("display","inline-block")},_disableDeleteBtnInPopup:function(){g(".atiButton.atiDeleteButton",this.editPopup.domNode).style("display","none")},_enableDeleBtnInPopup:function(){g(".atiButton.atiDeleteButton",this.editPopup.domNode).style("display","block")},_updateGeometryOperationButtons:function(a){this._getEditCapabilitiesByFeature(a).canUpdateGeometry?this._enableGeometryOperationButtons():this._disableGeometryOperationButtons()},_disableGeometryOperationButtons:function(){this._configEditor.toolbarVisible&&
(g("[widgetid\x3dbtnFeatureCut]",this.editor.domNode).style("display","none"),g("[widgetid\x3dbtnFeatureUnion]",this.editor.domNode).style("display","none"),g("[widgetid\x3dbtnFeatureReshape]",this.editor.domNode).style("display","none"),(this._configEditor.toolbarOptions.mergeVisible||this._configEditor.toolbarOptions.cutVisible||this._configEditor.toolbarOptions.reshapeVisible)&&g("[widgetid^\x3ddijit_ToolbarSeparator]",this.editor.domNode).last().style("display","none"))},_enableGeometryOperationButtons:function(){this._configEditor.toolbarVisible&&
(g("[widgetid\x3dbtnFeatureCut]",this.editor.domNode).style("display","inline-block"),g("[widgetid\x3dbtnFeatureUnion]",this.editor.domNode).style("display","inline-block"),g("[widgetid\x3dbtnFeatureReshape]",this.editor.domNode).style("display","inline-block"),(this._configEditor.toolbarOptions.mergeVisible||this._configEditor.toolbarOptions.cutVisible||this._configEditor.toolbarOptions.reshapeVisible)&&g("[widgetid^\x3ddijit_ToolbarSeparator]",this.editor.domNode).last().style("display","inline-block"))},
_updateDeleteButtonInToolbarBySelectionFeatures:function(){var a=!0,b=this._getSelectionFeatuers();0===b.length?a=!1:e.some(b,function(b){if(!this._getEditCapabilitiesByFeature(b).canDelete)return a=!1,!0},this);a?this._enableDeleBtnInToolbar():this._disableDeleteBtnInToolbar()},_update:function(a){this.editor&&(a&&(this._filterEditor&&this._filterEditor.update(),this.editor.templatePicker.featureLayers=a),this.editor.templatePicker.clearSelection(),this.editor.templatePicker.update(!0),this._changeMessageForTemplatePicker())},
resize:function(){this._update()},onNormalize:function(){setTimeout(d.hitch(this,this._update),100)},onMinimize:function(){},onMaximize:function(){setTimeout(d.hitch(this,this._update),100)},reClickMap:function(a){this._createOverDef.then(d.hitch(this,function(){this.map.onClick(a)}))},_onGraphicMoveStart:function(a){this._recordsSelectedFeatureInfoWhenMoveStart(a)},_onGraphicMoveStop:function(a){this._recordsSelectedFeatureInfoWhenMoveStop(a);this._autoApplyEditWhenGeometryIsModified(a)},_onGraphicChangeStop:function(a){this._autoApplyEditWhenGeometryIsModified(a)},
_beforeMapClick:function(){this._configEditor.autoApplyEditWhenGeometryIsMoved||this._checkStickyMoveTolerance()},_onEditorPopupShow:function(){var a=this.editor.attributeInspector._currentFeature;this._disableToAnswerEventForEditorATI();this._createRelatedRecordsEditor(a);this._pushToNeedRequeryFeatureArray(a);this._requeryFeature(a,!0);this._updateOperationalButtons(a)},_onEditorPopupHide:function(){this._enableToAnswerEventForEditorATI()},_onNextOfEditorATI:function(a){this._createRelatedRecordsEditor(a.feature);
this._pushToNeedRequeryFeatureArray(a.feature);this._requeryFeature(a.feature,!0);this._updateOperationalButtons(a.feature)},_onLayerSelectionChange:function(){this._updateDeleteButtonInToolbarBySelectionFeatures()}});q.EditPopup=A([Q],{preamble:function(){this.originalHide=d.hitch(this,this.hide);this.hide=d.hitch(this,function(a){this.hideWidthConfirmDialog(a)});v.setScrollable&&(this.originalSetScrollableDomUtils=v.setScrollable,v.setScrollable=function(){return[{remove:function(){}},{remove:function(){}}]})},
constructor:function(){v.setScrollable=this.originalSetScrollableDomUtils},hideWidthConfirmDialog:function(a){this.originalHide()}});d.mixin(q,{TOP:"18px",TOP_WITH_TEMPLATE_FILTER:"115px",TOP_WITH_EDIT_RG:"53px",TOP_WITH_TEMPLATE_FILTER_AND_EDIT_RG:"155px"});return q});