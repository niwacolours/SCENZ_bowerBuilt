//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/html dojo/topic dojo/on dojo/keys dojo/query dojo/dom-construct dojo/dom-geometry dojo/Deferred dojo/debounce require ../WidgetManager ../PanelManager ../utils ../dijit/LoadingShelter ./BaseLayoutManager ./GridMobileController".split(" "),function(B,c,f,h,q,l,r,u,g,t,n,y,v,C,D,p,E,F,z){var w=null,x;x=B([F],{isEditing:!1,maxStackId:0,dashboardWidgets:[],dashboardPanels:{},currentMode:0,_createLayoutDeferred:null,_isLastLayoutMobile:!1,
_isDestroying:!1,nls:null,_addWidgetTipTemplate:'\x3cdiv class\x3d"tip"\x3e\x3cdiv class\x3d"idx"\x3e${groupIndex}\x3c/div\x3e\x3cdiv class\x3d"label"\x3e${this.nls.addWidgetTip}\x3c/div\x3e\x3c/div\x3e',name:"GridLayoutManager",constructor:function(a,b){this.widgetManager=C.getInstance();this.panelManager=D.getInstance();this.widgetPlaceholders=[];this.preloadWidgetIcons=[];this.preloadGroupPanels=[];this.invisibleWidgetIds=[];p.isMobileUa()?this.own(l(window,"orientationchange",c.hitch(this,this.resize))):
this.own(l(window,"resize",c.hitch(this,this.resize)));this.id=b;this._createLayoutDeferred=null},postMixInProperties:function(){this.inherited(arguments);this.nls={};c.mixin(this.nls,window.jimuNls.gridLayout,window.jimuNls.common);this._addWidgetTipTemplate=this._addWidgetTipTemplate.replace("${this.nls.addWidgetTip}",this.nls.addWidgetTip)},isSupportEdit:function(){return!0},postCreate:function(){this.containerNode=this.domNode;this._isLastLayoutMobile=window.appInfo.isRunInMobile},layout:null,
map:null,mapContainer:null,mapId:"map",hlDiv:null,animTime:500,resize:function(){this._resizeLayout();f.forEach(this.widgetManager.getAllWidgets(),function(a){!1===a.inPanel&&a.resize()},this)},setMap:function(a){this.inherited(arguments);this.panelManager.setMap(a)},_resizeLayout:function(){if(window.appInfo.isRunInMobile){var a=t.getMarginBox(window.jimuConfig.layoutId),a=a.w>a.h?2:1;this.mobilePanel&&(this.currentMode!==a&&(this.currentMode=a,this.mobilePanel.setMobileLayout(a)),this.mobilePanel.resize())}var b;
!this.isEditing&&this.layout?(b=$(this.layoutContainer),a=b.width(),b=b.height(),this.layout.updateSize(a,b)):this.isEditing&&this.editingLayout&&(b=$(this.editLayoutDiv),a=b.width(),b=b.height(),this.editingLayout.updateSize(a,b))},loadAndLayout:function(a){this.appConfig=a;var b=new E;b.placeAt(this.layoutId);b.startup();this._setTabindex(a);this._createLayoutDeferred&&!this._createLayoutDeferred.isResolved()?a=this._createLayoutDeferred:(a=new n,a.resolve());a.then(c.hitch(this,this._loadOnScreenGroups)).then(c.hitch(this,
this._reArrangeWidgetsLayout,!0)).then(c.hitch(this,function(){b&&(b.destroy(),b=null);console.timeEnd("Load widgetOnScreen");q.publish("preloadWidgetsLoaded")}),c.hitch(this,function(){b&&(b.destroy(),b=null);console.timeEnd("Load widgetOnScreen");q.publish("preloadWidgetsLoaded")}))},_setTabindex:function(a){function b(a,b){a&&("undefined"!==typeof a.bottom&&(a.top=b.h-a.bottom-100,delete a.bottom),"undefined"!==typeof a.right&&(a.left=b.w-a.right-100,delete a.right))}function d(a,d,e){d=c.clone(d.position||
d.panel&&d.panel.position);e=c.clone(e.position||e.panel&&e.panel.position);b(d,a);b(e,a);return d.top===e.top?d.left-e.left:d.top-e.top}var e=[],m=[];a.visitElement(function(a,b){b.isOnScreen&&(b=a.position||a.panel&&a.panel.position)&&!Array.isArray(a.widgets)&&"widgetOnScreen"===a.gid&&a.visible&&("browser"===b.relativeTo?e.push(a):m.push(a))});a=t.getMarginBox(this.layoutId);var f=t.getMarginBox(this.mapId),e=e.sort(c.hitch(this,d,a));e.sort(function(a,b){return"Splash"===a.name?-1:"Splash"===
b.name?1:0});var m=m.sort(c.hitch(this,d,f)),k=1;e.forEach(function(a){a.tabIndex=k;k=a.isController?k+5E3:k+200});var g=u(".lm_item.lm_stack",this.layoutContainer);for(a=0;a<=g.length-1;a++)f=g[a],f.tabIndex=k-1,this.own(l(f,"keydown",c.hitch(this,function(a,b){h.hasClass(b.target,"lm_stack")?b.keyCode===r.ENTER?(a=u(".jimu-widget",a)[0])&&(h.hasClass(a.parentNode,"map")?this.map.container.focus():p.focusFirstFocusNode(a)):b.keyCode!==r.TAB||b.shiftKey||a.nextSibling||a.parentNode.nextSibling||(b.preventDefault(),
0<e.length?(a=e[0].id,0>a.indexOf("Splash")?(a=u("#"+a)[0],a.focus()):1<e.length?(a=u("#"+e[1].id)[0],a.focus()):g[0].focus()):g[0].focus()):b.keyCode===r.ESCAPE&&a.focus()},f)));h.setAttr(this.map.container,"tabindex",k);h.setAttr(this.map.container,"aria-label",window.jimuNls.gridLayout.mapArea);this.own(l(this.map.container,"keydown",c.hitch(this,function(a){"map"===h.getAttr(a.target,"id")&&(a.keyCode===r.ESCAPE?p.trapToNextFocusContainer(this.map.container):a.shiftKey&&a.keyCode===r.TAB&&a.preventDefault())})));
this.own(l(this.map.container,"focus",c.hitch(this,function(a){p.isInNavMode()&&"map"===h.getAttr(a.target,"id")&&(a=document.getElementById("map_container"),a.addEventListener("mouseover",function(){}),a.simulateEvent=new MouseEvent("mouseover",{view:window,bubbles:!0,cancelable:!0}),this.map.isKeyboardNavigationOrigin=this.map.isKeyboardNavigation,a.dispatchEvent(a.simulateEvent)&&this.map.enableKeyboardNavigation())})));this.own(l(this.map.container,"blur",c.hitch(this,function(a){p.isInNavMode()&&
"map"===h.getAttr(a.target,"id")&&(document.getElementById("map_container").removeEventListener("mouseover",function(){}),this.map.isKeyboardNavigationOrigin||this.map.disableKeyboardNavigation())})));k+=1E3;m.forEach(function(a){a.inPanel?a.tabIndexJimu=k:a.tabIndex=k;k=a.isController?k+5E3:k+200})},createMapDiv:function(a){h.byId(a)?this.mapDiv=h.byId(a):this.mapDiv=h.create("div",{id:a,style:c.mixin({position:"absolute",backgroundColor:"#EEEEEE",overflow:"hidden",minWidth:"1px",minHeight:"1px"},
p.getPositionStyle(this.appConfig.map.position))},this.layoutId)},getMapDiv:function(){return this.mapDiv},onThemeLoad:function(){this._resizeLayout()},_enableEditing:function(){this.isEditing||(this._createEditingLayout(),$(this.layoutContainer).addClass("hidden"),$(this.editContainer).removeClass("hidden"),$(this.modifyLayoutBtn).addClass("hidden"),this.isEditing=!0,this._resizeLayout())},_disableEditing:function(){$(this.layoutContainer).removeClass("hidden");$(this.editContainer).addClass("hidden");
$(this.modifyLayoutBtn).removeClass("hidden");this.isEditing=!1;this._resizeLayout()},_resetLayoutDefinition:function(){this._disableEditing();this._createLayout(!1,!1);q.publish("editLayoutCancelled")},_saveLayoutDefinition:function(){var a=c.clone(this.editingLayout.toConfig()),b=c.clone(this.appConfig.layoutDefinition);this._simplifyLayoutDefinition(a.content[0]);this._disableEditing();var d=this.editingLayout.root.contentItems[0].getItemsByType("stack"),e=[];f.forEach(d,function(a){!f.some(a.contentItems,
c.hitch(this,function(a){if(a.isComponent&&"map"===a.config.componentName)return!0}))&&/^dd_group_\d+$/.test(a.config.id)&&e.push(a.config.id)});b.layout.config.content=a.content;q.publish("layoutDefinitionChanged",{layoutDefinition:b,groupIds:e})},_simplifyLayoutDefinition:function(a){if("component"!==a.type)if("stack"===a.type){var b;a.activeItemIndex=0;f.some(a.content,c.hitch(this,function(a){if("component"===a.type&&"map"===a.componentName)return b=a,!0}));b?(a.id="map",a.content=[b]):a.content=
[]}else f.forEach(a.content,c.hitch(this,function(a){this._simplifyLayoutDefinition(a)}))},_bindLayoutEvents:function(){this.editingLayout.on("initialised",c.hitch(this,function(){this.editingLayout.createDragSource($(this.dragCreateBtn),{title:" ",type:"component",reorderEnabled:!1,componentName:"widget panel"});var a=this.editingLayout.root.contentItems[0].getItemsByType("stack"),b=[];f.forEach(a,function(a){/^dd_group_\d+$/.test(a.config.id)&&(a=parseInt(a.config.id.split("_")[2],10),b.push(a))});
0<b.length?(b=b.sort(function(a,b){return a>b}),this.maxStackId=b[b.length-1]):this.maxStackId=0;this._arrangeWidgetsInEditingLayout()}));this.editingLayout.on("stackCreated",c.hitch(this,function(a){this.maxStackId++;a.config.id||(a.config.id="dd_group_"+this.maxStackId)}))},_arrangeWidgetsInEditingLayout:function(){f.forEach(this.appConfig.widgetOnScreen.groups,c.hitch(this,function(a){a=this.appConfig.getConfigElementById(a.id);var b=this.editingLayout.root.contentItems[0].getItemsById(a.id),d;
b&&0<b.length&&"stack"===b[0].type&&(d=b[0]);d&&f.forEach(a.widgets,c.hitch(this,function(a,b){var e={id:a.id,type:"component",title:a.label,reorderEnabled:!1,componentName:"widget panel",componentState:{label:a.label}};d.contentItems.length>b?(b=d.contentItems[b],b.config.id=a.id,b.setTitle(a.label)):d.addChild(e)}))}))},_createActionBar:function(a){if(!this.actionBar){this.actionBar=g.create("div",{"class":"layout-actionbar"},a);this.dragCreateBtn=g.create("div",{"class":"jimu-btn jimu-float-leading jimu-leading-margin2 add-btn",
innerHTML:this.nls.dragToAdd},this.actionBar);a=g.create("div",{"class":"jimu-btn-vacation jimu-float-trailing jimu-trailing-margin2 cancel-btn",innerHTML:this.nls.cancel},this.actionBar);var b=g.create("div",{"class":"jimu-btn jimu-float-trailing save-btn",innerHTML:this.nls.ok},this.actionBar);this.own(l(a,"click",c.hitch(this,this._resetLayoutDefinition)));this.own(l(b,"click",c.hitch(this,this._saveLayoutDefinition)))}},_destroyActionBar:function(){g.destroy(this.actionBar);this.actionBar=null},
_createLayout:function(a,b,d){return this._createLayoutDeferred&&!this._createLayoutDeferred.isResolved()?this._createLayoutDeferred.then(c.hitch(this,function(){return this._doCreateLayout(a,b,d)})):this._doCreateLayout(a,b,d)},_doCreateLayout:function(a,b,d){var e,m=new n;this._createLayoutDeferred=new n;if(this.isEditing)return this._createEditingLayout();window.appInfo.isRunInMobile?e=c.hitch(this,this._createMobileLayout):(this.mobileController&&(this.mobileController.destroyOnScreenWidgets(),
this.mobileController.destroy(),this.mobileController=null),e=c.hitch(this,this._createNormalLayout));d?e().then(c.hitch(this,function(){this._createLayoutDeferred.resolve();m.resolve()})):a?e().then(c.hitch(this,this._loadOnScreenGroups)).then(c.hitch(this,this._reArrangeWidgetsLayout,b)).then(c.hitch(this,function(){this._createLayoutDeferred.resolve();m.resolve()})):e().then(c.hitch(this,this._reArrangeWidgetsLayout,b)).then(c.hitch(this,function(){this._createLayoutDeferred.resolve();m.resolve()}));
return m},_detachWidgets:function(a){if("stack"===a.type){for(;1<a.contentItems.length;)a.removeChild(a.contentItems[0],!0);var b=a.contentItems[0];a.addChild({type:"component",componentName:"widget panel",title:" ",isClosable:!1});a.removeChild(b,!0)}else f.forEach(a.contentItems,c.hitch(this,function(a){this._detachWidgets(a)}))},_setupWidgets:function(a,b){a.isClosable=b;"component"!==a.type&&("stack"===a.type?0===a.content.length&&(a.content=[{type:"component",componentName:"widget panel",title:" ",
isClosable:b}]):f.forEach(a.content,c.hitch(this,function(a){this._setupWidgets(a)})))},_onActivePanelChanged:function(a){var b;if(!this._isDestroying&&"widget panel"===a.componentName&&a.config.id){(b=this.dashboardPanels[a.config.id])&&b.domNode?(0===a.container.getElement().find(".jimu-panel").length&&(a.container.getElement().html(b.domNode),a.container.on("resize",y(c.hitch(this,function(){0<a.container.width&&0<a.container.height&&b&&b.resize()}),200))),b.resize(),this.panelManager.openPanel(b)):
this._loadDashboardWidget(a.config.id).then(c.hitch(this,function(b){b&&(a.container.getElement().html(b.domNode),a.container.on("resize",y(c.hitch(this,function(){0<a.container.width&&0<a.container.height&&b.resize()}),200)),b.resize(),this.panelManager.openPanel(b))}));var d=a.parent.config.id,e;f.some(this.appConfig.widgetOnScreen.groups,c.hitch(this,function(a){if(a.id===d)return e=a.widgets,!0}));f.forEach(e,c.hitch(this,function(e){e.id!==a.config.id&&(b=this.dashboardPanels[e.id])&&this.panelManager.closePanel(b)}))}},
_createNormalLayout:function(){var a=new n;this._isDestroying=!1;this.layoutContainer||(this.layoutContainer=g.create("div",{"class":"config"===this.appConfig.mode?"jimu-dnd-layout config":"jimu-dnd-layout"},this.layoutId),"config"===this.appConfig.mode&&(this.modifyLayoutBtn=g.create("div",{"class":"jimu-dnd-layout modify-btn",innerHTML:'\x3cdiv class\x3d"jimu-ellipsis"\x3e\x3cspan class\x3d"feature-action icon-edit"\x3e\x3c/span\x3e'+this.nls.modifyLayout+"\x3c/div\x3e"},this.layoutId),this.own(l(this.modifyLayoutBtn,
"click",c.hitch(this,function(){q.publish("editLayout")})))));f.some(this.appConfig.widgetOnScreen.widgets,function(a){if("themes/DashboardTheme/widgets/Header/Widget"===a.uri)return a.visible?h.setStyle(this.layoutContainer,"top","80px"):(this._removeHighLight(a.id),h.setStyle(this.layoutContainer,"top",0)),!0},this);var b=this.layout,d=c.clone(this.appConfig.layoutDefinition.layout.config);"config"===this.appConfig.mode&&(d.settings.reorderEnabled=!1,d.settings.resizeEnabled=!1,d.settings.enableHeaderDragging=
!1,d.dimensions={borderWidth:5,dragProxyWidth:0,dragProxyHeight:0});this._setupWidgets(d.content[0],!1);v(["libs/goldenlayout/goldenlayout"],c.hitch(this,function(e){"config"===this.appConfig.mode&&$(this.modifyLayoutBtn).removeClass("hidden");this.layout=new e(d,this.layoutContainer);this.layout.registerComponent("widget panel",c.hitch(this,function(a,b){var e=a.parent.parent.config.id,d;b.widgetId||(b=this._addWidgetTipTemplate,f.some(this.appConfig.widgetOnScreen.groups,function(a){if(a.id===e)return"config"===
this.appConfig.mode&&0===a.widgets.length&&(d=a.placeholderIndex),!0},this),d&&(b=b.replace("${groupIndex}",d),a.getElement().html(b)))}));this.layout.registerComponent("map",c.hitch(this,function(a){a.setTitle("");this.mapContainer=a.getElement();$("#"+this.mapId).appendTo(this.mapContainer);b&&(this._isDestroying=!0,this._detachWidgets(b.root.contentItems[0]),b.destroy(),this._isDestroying=!1);this.mobilePanel&&(this.mobilePanel.destroy(),this.mobilePanel=null)}));this.layout.on("initialised",c.hitch(this,
function(){var b=$(this.layoutContainer),e=b.width(),b=0<b.height()?b.height():$("#"+this.layoutId).height();this.layout.updateSize(e,b);a.resolve()}));this.layout.on("stackCreated",c.hitch(this,function(a){a.on("activeContentItemChanged",c.hitch(this,function(a){this._onActivePanelChanged(a)}))}));this.layout.init()}));return a},_createMobileLayout:function(){var a=new n;this.modifyLayoutBtn&&$(this.modifyLayoutBtn).addClass("hidden");if(this.mobilePanel)this.mobilePanel.clearPanels(),a.resolve();
else{this.layout&&(this._isDestroying=!0,this._detachWidgets(this.layout.root.contentItems[0]),this._isDestroying=!1);var b=t.getMarginBox(window.jimuConfig.layoutId);this._loadMobilePanel(this.layoutId,b.w>b.h?2:1).then(c.hitch(this,function(){this.layout&&(this.layout.destroy(),this.layout=null);a.resolve()}))}return a},_createEditingLayout:function(){this.editContainer||(this.editContainer=g.create("div",{"class":"jimu-edit-layout hidden"},this.layoutId),this._createActionBar(this.editContainer),
this.editLayoutDiv=g.create("div",{"class":"layout-container"},this.editContainer));var a=this.editingLayout,b=c.clone(this.appConfig.layoutDefinition.layout.config);b.settings.enableHeaderDropping=!1;b.settings.reorderEnabled=!1;b.dimensions={borderWidth:5,dragProxyWidth:0,dragProxyHeight:0};this._setupWidgets(b.content[0],!0);v(["libs/goldenlayout/goldenlayout"],c.hitch(this,function(d){this.editingLayout=new d(b,this.editLayoutDiv);this.editingLayout.registerComponent("widget panel",c.hitch(this,
function(a){a.getElement().html("")}));this.editingLayout.registerComponent("map",c.hitch(this,function(b){b.setTitle("");b.getElement().html('\x3cdiv class\x3d"maptip"\x3e'+this.nls.mapArea+"\x3c/div\x3e");a&&a.destroy()}));this._bindLayoutEvents();this.editingLayout.init()}))},_destroyLayout:function(){$("#"+this.mapId).appendTo("#"+this.layoutId);this.layout&&(this.layout.destroy(),this.layout=null,g.destroy(this.layoutContainer),this.layoutContainer=null,this.modifyLayoutBtn&&(g.destroy(this.modifyLayoutBtn),
this.modifyLayoutBtn=null));this.editingLayout&&(this._destroyActionBar(),this.editingLayout.destroy(),this.editingLayout=null,g.destroy(this.editContainer),this.editContainer=null)},destroyOnScreenWidgetsAndGroups:function(){this._destroyOnScreenWidgets();this._destroyOnScreenGroups()},onActionTriggered:function(a){if(!window.appInfo.isRunInMobile)if("editLayout"===a.action)this._enableEditing();else if("highLight"===a.action){var b=this._findContentItemById(a.elementId);b?b.isStack?$(b.element).addClass("highlight"):
b.isComponent&&$(b.tab.element).addClass("highlight"):(f.forEach(this.widgetPlaceholders,function(b){b.configId===a.elementId&&this._highLight(b)},this),f.forEach(this.onScreenWidgetIcons,function(b){b.configId===a.elementId&&this._highLight(b)},this),f.forEach(this.widgetManager.getOnScreenOffPanelWidgets(),function(b){b.configId===a.elementId&&this._highLight(b)},this))}else"removeHighLight"===a.action?this._removeHighLight(a.elementId):"showLoading"===a.action?(h.setStyle(jimuConfig.loadingId,
"display","block"),h.setStyle(jimuConfig.mainPageId,"display","none")):"showApp"===a.action&&(h.setStyle(jimuConfig.loadingId,"display","none"),h.setStyle(jimuConfig.mainPageId,"display","block"))},_findContentItemById:function(a,b){return(a=this.layout.root.contentItems[0].getItemsById(a))&&0<a.length&&(!b||b===a[0].type)?a[0]:null},_highLight:function(a){if(a.domNode){this.hlDiv&&this._removeHighLight(a);var b=t.getMarginBox(a.domNode);this.hlDiv=g.create("div",{style:{position:"absolute",left:b.l+
"px",top:b.t+"px",width:b.w+"px",height:b.h+"px"},"class":"icon-highlight"},a.domNode,"before")}},_removeHighLight:function(a){/^dd_group_\d+$/.test(a)?(a=this._findContentItemById(a,"stack"))&&$(a.element).removeClass("highlight"):/^widgets_\w+_\d+$/.test(a)&&(a=this._findContentItemById(a,"component"))&&$(a.tab.element).removeClass("highlight");this.hlDiv&&(g.destroy(this.hlDiv),this.hlDiv=null)},onEnter:function(a,b){this.appConfig=a;this.mapId=b;this.isEditing=!1;this.createMapDiv(b);return this._createLayout(!1,
!1,!0)},onLeave:function(){this._destroyLayout();this.map=null},onWidgetChange:function(a,b){this.appConfig=a;"themes/DashboardTheme/widgets/Header/Widget"===b.uri&&(b.visible?h.setStyle(this.layoutContainer,"top","80px"):(this._removeHighLight(b.id),h.setStyle(this.layoutContainer,"top",0)),this._resizeLayout());b=a.getConfigElementById(b.id);var d=this.dashboardPanels[b.id];d?(d.reloadWidget(b),(a=this.layout.root.contentItems[0].getItemsByType("component"))&&0<a.length&&a.forEach(function(a){a.config.id===
b.id&&a.config.title!==b.label&&(a.config.title=b.label,a.setTitle(b.label))})):(this.mobileController&&(this.mobileController.destroy(),this.mobileController=new z({appConfig:this.appConfig,panelContainerNode:this.mobilePanel.widgetContainerNode}),this.mobileController.placeAt(this.mapId)),this.onOnScreenWidgetChange(a,b))},onOnScreenGroupsChange:function(a){this.appConfig=a;this._createLayout(!0,!1)},onGroupChange:function(a,b){this.appConfig=a;b=a.getConfigElementById(b.id);b.isOnScreen?this._createLayout(!0,
!1):(f.forEach(this.widgetManager.getControllerWidgets(),function(d){d.isControlled(b.id)&&this.reloadControllerWidget(a,d.id)},this),f.forEach(this.panelManager.panels,function(a){a.config.id===b.id&&a.updateConfig(b)},this))},_reArrangeWidgetsLayout:function(a){a&&this._destroyOnScreenWidgets();window.appInfo.isRunInMobile?(a&&this._loadMobileOnScreenWidgets(),this.mobilePanel.setPanels(this.dashboardWidgets,this.dashboardPanels)):(a&&this.loadOnScreenWidgets(this.appConfig),this._reArrangeWidgetsInDesktopLayout())},
_reArrangeWidgetsInDesktopLayout:function(){f.forEach(this.appConfig.widgetOnScreen.groups,c.hitch(this,function(a){a=this.appConfig.getConfigElementById(a.id);var b=this._findContentItemById(a.id,"stack");b&&f.forEach(a.widgets,c.hitch(this,function(a,e){var c={id:a.id,type:"component",title:a.label,componentName:"widget panel",componentState:{widgetId:a.id}};b.contentItems.length>e?(e=b.contentItems[e],e.config.id=a.id,e.config.title=a.label,e.config.componentState={widgetId:a.id},e.setTitle(a.label),
b.setActiveContentItem(e)):b.addChild(c)}))}))},_loadMobileOnScreenWidgets:function(){this.mobileController=new z({appConfig:this.appConfig,panelContainerNode:this.mobilePanel.widgetContainerNode});this.mobileController.placeAt(this.mapId);f.forEach(this.appConfig.widgetOnScreen.widgets,function(a){a.uri&&a.visible&&!a.closeable&&this.loadOnScreenWidget(a,this.appConfig)},this)},_loadMobilePanel:function(a,b){var d=this.appConfig.layoutDefinition.mobileLayout.panel,e=new n;v([d.uri],c.hitch(this,
function(d){this.mobilePanel=new d({layoutId:this.layoutId,mapId:this.mapId,mobileLayout:b,config:{},layoutManager:this});this.own(l(this.mobilePanel,"resized",y(c.hitch(this,function(a){this.mobileController&&this.mobileController.setPanelPosition(a)}),200)));g.place(this.mobilePanel.domNode,a);e.resolve()}));return e},_loadDashboardWidget:function(a){var b=new n,d=this.dashboardPanels[a];if(d&&d.domNode)return b.resolve(this.dashboardPanels[a]),b;var e;f.some(this.appConfig.widgetOnScreen.groups,
c.hitch(this,function(b){return f.some(b.widgets,c.hitch(this,function(b){if(b.id===a)return e=b,!0}))}));if(!e)return b.resolve(null),b;var g=this.appConfig.layoutDefinition.layout.panel;v([g.uri],c.hitch(this,function(d){var f={config:e,uri:g.uri,map:this.map,widgetManager:this.widgetManager,panelManager:this.panelManager,id:a+"_panel",position:{}},h;c.mixin(f,e.options);try{h=new d(f),this.dashboardPanels[a]=h,b.resolve(h),console.log("panel ["+f.id+"] created.")}catch(A){console.log("create panel error: "+
A+", panelId: "+f.id),b.reject(A)}}));return b},onLayoutDefinitionChange:function(a){this.appConfig=a;this._createLayout(!1,!1)},onLayoutChange:function(a){var b=window.appInfo.isRunInMobile,d=!1;this.isEditing||(b!==this._isLastLayoutMobile&&(d=!0,this._isLastLayoutMobile=b),this.appConfig=a,this._createLayout(!1,d).then(c.hitch(this,function(){f.forEach(this.widgetPlaceholders,function(b){b.moveTo(a.getConfigElementById(b.configId).position)},this);f.forEach(this.onScreenWidgetIcons,function(b){b.moveTo(a.getConfigElementById(b.configId).position)},
this);f.forEach(this.widgetManager.getOnScreenOffPanelWidgets(),function(b){if(!b.closeable){var c=a.getConfigElementById(b.id).position;b.setPosition(c)}},this)})))},openWidget:function(a){var b,c;f.forEach(this.onScreenWidgetIcons,function(b){b.configId===a&&b.switchToOpen()},this);(b=this._findContentItemById(a,"component"))&&(c=b.parent)&&c.isStack&&c.setActiveContentItem(b)},_loadOnScreenGroups:function(){var a=this.appConfig.widgetOnScreen.groups,b=[],d=new n;f.forEach(a,c.hitch(this,function(a){a=
this.appConfig.getConfigElementById(a.id);f.forEach(a.widgets,function(a){b.push(a.id)})}));f.forEach(this.dashboardWidgets,c.hitch(this,function(a){if(0>b.indexOf(a)){var c=this.dashboardPanels[a];c&&(this.panelManager.closePanel(c),c.destroy());this.dashboardPanels[a]=null}}));this.dashboardWidgets=b;d.resolve();return d},_destroyOnScreenWidgets:function(){this.destroyOnScreenOffPanelWidgets();this.destroyWidgetPlaceholders();this.destroyOnScreenWidgetIcons();this.mobileController&&(this.mobileController.destroy(),
this.mobileController=null)},_destroyOnScreenGroups:function(){f.forEach(this.dashboardWidgets,c.hitch(this,function(a){if(a=this.dashboardPanels[a])this.panelManager.closePanel(a),a.destroy(),a=null}));this.panelManager.destroyAllPanels();this.dashboardWidgets=[];this.dashboardPanels={};this.mobilePanel&&this.mobilePanel.clearPanels()}});x.getInstance=function(a,b){null===w&&(w=new x(a,b),window._layoutManager=w);return w};return x});