//>>built
define(["require","exports","./Geometry","./GeometryUtils"],function(u,x,m,v){Object.defineProperty(x,"__esModule",{value:!0});var w=function(){return function(e,a,b){this.ratio=e;this.x=a;this.y=b}}();u=function(){function e(a,b,h,g,d){void 0===g&&(g=8);void 0===d&&(d=8);this.lines=[];this.starts=[];this.pixelRatio=g;this.pixelMargin=d;this.tileSize=512*g;this.dz=a;this.yPos=b;this.xPos=h}return e.prototype.setExtent=function(a){this.finalRatio=this.tileSize/a*(1<<this.dz);var b=this.pixelRatio*
this.pixelMargin,b=b/this.finalRatio;a>>=this.dz;b>a&&(b=a);this.margin=b;this.xmin=a*this.xPos-b;this.ymin=a*this.yPos-b;this.xmax=this.xmin+a+2*b;this.ymax=this.ymin+a+2*b},e.prototype.reset=function(a){this.type=a;this.lines=[];this.starts=[];this.line=null;this.start=0},e.prototype.moveTo=function(a,b){this._pushLine();this._prevIsIn=this._isIn(a,b);this._moveTo(a,b,this._prevIsIn);this._prevPt=new m.Point(a,b);this._firstPt=new m.Point(a,b);this._dist=0},e.prototype.lineTo=function(a,b){var h,
g,d,f,c,l,e,p,n=this._isIn(a,b),k=new m.Point(a,b),q=m.Point.distance(this._prevPt,k);if(n)this._prevIsIn?this._lineTo(a,b,!0):(h=this._prevPt,g=k,d=this._intersect(g,h),this.start=this._dist+q*(1-this._r),this._lineTo(d.x,d.y,!0),this._lineTo(g.x,g.y,!0));else if(this._prevIsIn)g=this._prevPt,h=k,d=this._intersect(g,h),this._lineTo(d.x,d.y,!0),this._lineTo(h.x,h.y,!1);else{b=this._prevPt;if(!(b.x<=this.xmin&&k.x<=this.xmin||b.x>=this.xmax&&k.x>=this.xmax||b.y<=this.ymin&&k.y<=this.ymin||b.y>=this.ymax&&
k.y>=this.ymax))if(a=[],(b.x<this.xmin&&k.x>this.xmin||b.x>this.xmin&&k.x<this.xmin)&&(f=(this.xmin-b.x)/(k.x-b.x),p=b.y+f*(k.y-b.y),p<=this.ymin?l=!1:p>=this.ymax?l=!0:a.push(new w(f,this.xmin,p))),(b.x<this.xmax&&k.x>this.xmax||b.x>this.xmax&&k.x<this.xmax)&&(f=(this.xmax-b.x)/(k.x-b.x),p=b.y+f*(k.y-b.y),p<=this.ymin?l=!1:p>=this.ymax?l=!0:a.push(new w(f,this.xmax,p))),(b.y<this.ymin&&k.y>this.ymin||b.y>this.ymin&&k.y<this.ymin)&&(f=(this.ymin-b.y)/(k.y-b.y),e=b.x+f*(k.x-b.x),e<=this.xmin?c=!1:
e>=this.xmax?c=!0:a.push(new w(f,e,this.ymin))),(b.y<this.ymax&&k.y>this.ymax||b.y>this.ymax&&k.y<this.ymax)&&(f=(this.ymax-b.y)/(k.y-b.y),e=b.x+f*(k.x-b.x),e<=this.xmin?c=!1:e>=this.xmax?c=!0:a.push(new w(f,e,this.ymax))),0===a.length)c?l?this._lineTo(this.xmax,this.ymax,!0):this._lineTo(this.xmax,this.ymin,!0):l?this._lineTo(this.xmin,this.ymax,!0):this._lineTo(this.xmin,this.ymin,!0);else if(1<a.length&&a[0].ratio>a[1].ratio)this.start=this._dist+q*a[1].ratio,this._lineTo(a[1].x,a[1].y,!0),this._lineTo(a[0].x,
a[0].y,!0);else for(this.start=this._dist+q*a[0].ratio,f=0;f<a.length;f++)this._lineTo(a[f].x,a[f].y,!0);this._lineTo(k.x,k.y,!1)}this._dist+=q;this._prevIsIn=n;this._prevPt=k},e.prototype.close=function(){if(2<this.line.length){var a=this._firstPt,b=this._prevPt;a.x===b.x&&a.y===b.y||this.lineTo(a.x,a.y);a=this.line;for(b=a.length;4<=b&&(a[0].x===a[1].x&&a[0].x===a[b-2].x||a[0].y===a[1].y&&a[0].y===a[b-2].y);)a.pop(),a[0].x=a[b-2].x,a[0].y=a[b-2].y,--b}},e.prototype.result=function(a){return void 0===
a&&(a=!0),this._pushLine(),0===this.lines.length?null:(3===this.type&&a&&y.simplify(this.tileSize,this.margin*this.finalRatio,this.lines),this.lines)},e.prototype.resultWithStarts=function(){if(2!==this.type)throw Error("Only valid for lines");this._pushLine();var a=this.lines,b=a.length;if(0===b)return null;for(var h=[],g=0;g<b;g++)h.push({line:a[g],start:this.starts[g]||0});return h},e.prototype._isIn=function(a,b){return a>=this.xmin&&a<=this.xmax&&b>=this.ymin&&b<=this.ymax},e.prototype._intersect=
function(a,b){var h,g,d;if(b.x>=this.xmin&&b.x<=this.xmax)g=b.y<=this.ymin?this.ymin:this.ymax,d=(g-a.y)/(b.y-a.y),h=a.x+d*(b.x-a.x);else if(b.y>=this.ymin&&b.y<=this.ymax)h=b.x<=this.xmin?this.xmin:this.xmax,d=(h-a.x)/(b.x-a.x),g=a.y+d*(b.y-a.y);else{g=b.y<=this.ymin?this.ymin:this.ymax;h=b.x<=this.xmin?this.xmin:this.xmax;var f=(h-a.x)/(b.x-a.x),c=(g-a.y)/(b.y-a.y);f<c?(d=f,g=a.y+f*(b.y-a.y)):(d=c,h=a.x+c*(b.x-a.x))}return this._r=d,new m.Point(h,g)},e.prototype._pushLine=function(){this.line&&
(1===this.type?0<this.line.length&&(this.lines.push(this.line),this.starts.push(this.start)):2===this.type?1<this.line.length&&(this.lines.push(this.line),this.starts.push(this.start)):3===this.type&&3<this.line.length&&(this.lines.push(this.line),this.starts.push(this.start)));this.line=[];this.start=0},e.prototype._moveTo=function(a,b,h){3!==this.type?h&&(a=Math.round((a-(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),this.line.push(new m.Point(a,
b))):(h||(a<this.xmin&&(a=this.xmin),a>this.xmax&&(a=this.xmax),b<this.ymin&&(b=this.ymin),b>this.ymax&&(b=this.ymax)),a=Math.round((a-(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),this.line.push(new m.Point(a,b)),this._is_h=!1,this._is_v=!1)},e.prototype._lineTo=function(a,b,h){var g,d;if(3!==this.type)h?(a=Math.round((a-(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),0<this.line.length&&(g=
this.line[this.line.length-1],g.equals(a,b)))||this.line.push(new m.Point(a,b)):this.line&&0<this.line.length&&this._pushLine();else if(h||(a<this.xmin&&(a=this.xmin),a>this.xmax&&(a=this.xmax),b<this.ymin&&(b=this.ymin),b>this.ymax&&(b=this.ymax)),a=Math.round((a-(this.xmin+this.margin))*this.finalRatio),b=Math.round((b-(this.ymin+this.margin))*this.finalRatio),this.line&&0<this.line.length){g=this.line[this.line.length-1];h=g.x===a;var f=g.y===b;h&&f||(this._is_h&&h?(g.x=a,g.y=b,d=this.line[this.line.length-
2],d.x===a&&d.y===b?(this.line.pop(),1>=this.line.length?(this._is_h=!1,this._is_v=!1):(d=this.line[this.line.length-2],this._is_h=d.x===a,this._is_v=d.y===b)):(this._is_h=d.x===a,this._is_v=d.y===b)):this._is_v&&f?(g.x=a,g.y=b,d=this.line[this.line.length-2],d.x===a&&d.y===b?(this.line.pop(),1>=this.line.length?(this._is_h=!1,this._is_v=!1):(d=this.line[this.line.length-2],this._is_h=d.x===a,this._is_v=d.y===b)):(this._is_h=d.x===a,this._is_v=d.y===b)):(this.line.push(new m.Point(a,b)),this._is_h=
h,this._is_v=f))}else this.line.push(new m.Point(a,b))},e}();x.TileClipper=u;u=function(){function e(){}return e.prototype.setExtent=function(a){this._ratio=4096===a?1:4096/a},e.prototype.reset=function(a){this.type=a;this.lines=[];this.line=null},e.prototype.moveTo=function(a,b){this.line&&this.lines.push(this.line);this.line=[];var h=this._ratio;this.line.push(new m.Point(Math.round(a*h),Math.round(b*h)))},e.prototype.lineTo=function(a,b){var h=this._ratio;this.line.push(new m.Point(Math.round(a*
h),Math.round(b*h)))},e.prototype.close=function(){var a=this.line;a&&!a[0].isEqual(a[a.length-1])&&a.push(a[0])},e.prototype.result=function(){return this.line&&this.lines.push(this.line),0===this.lines.length?null:(3===this.type&&1!==this._ratio&&y.simplify(4096,64,this.lines),this.lines)},e}();x.SimpleBuilder=u;var y=function(){function e(){}return e.simplify=function(a,b,h){if(h){var g=-b,d=a+b,f=-b,c=a+b;a=[];b=[];for(var l=h.length,r=0;r<l;++r){var p=h[r];if(p&&!(2>p.length))for(var n=p[0],
k=void 0,q=p.length,t=1;t<q;++t)k=p[t],n.x===k.x&&(n.x<=g&&(n.y>k.y?(a.push(r),a.push(t),a.push(0),a.push(-1)):(b.push(r),b.push(t),b.push(0),b.push(-1))),n.x>=d&&(n.y<k.y?(a.push(r),a.push(t),a.push(1),a.push(-1)):(b.push(r),b.push(t),b.push(1),b.push(-1)))),n.y===k.y&&(n.y<=f&&(n.x<k.x?(a.push(r),a.push(t),a.push(2),a.push(-1)):(b.push(r),b.push(t),b.push(2),b.push(-1))),n.y>=c&&(n.x>k.x?(a.push(r),a.push(t),a.push(3),a.push(-1)):(b.push(r),b.push(t),b.push(3),b.push(-1)))),n=k}0!==a.length&&0!==
b.length&&(e.fillParent(h,b,a),e.fillParent(h,a,b),g=[],e.calcDeltas(g,b,a),e.calcDeltas(g,a,b),e.addDeltas(g,h))}},e.fillParent=function(a,b,h){for(var g=h.length,d=b.length,f=0;f<d;f+=4){for(var c=b[f],e=b[f+1],r=b[f+2],p=a[c][e-1],c=a[c][e],e=8092,n=-1,k=0;k<g;k+=4)if(h[k+2]===r){var q=h[k],t=h[k+1],m=a[q][t-1],q=a[q][t];switch(r){case 0:case 1:v.between(p.y,m.y,q.y)&&v.between(c.y,m.y,q.y)&&(m=Math.abs(q.y-m.y),m<e&&(e=m,n=k));break;case 2:case 3:v.between(p.x,m.x,q.x)&&v.between(c.x,m.x,q.x)&&
(m=Math.abs(q.x-m.x),m<e&&(e=m,n=k))}}b[f+3]=n}},e.calcDeltas=function(a,b,h){for(var g=b.length,d=0;d<g;d+=4){var f=e.calcDelta(d,b,h,[]);a.push(b[d]);a.push(b[d+1]);a.push(b[d+2]);a.push(f)}},e.calcDelta=function(a,b,h,g){a=b[a+3];if(-1===a)return 0;var d=g.length;return 1<d&&g[d-2]===a?0:(g.push(a),e.calcDelta(a,h,b,g)+1)},e.addDeltas=function(a,b){for(var e=a.length,g=0,d=0;d<e;d+=4){var f=a[d+3];f>g&&(g=f)}for(d=0;d<e;d+=4){var c=b[a[d]],l=a[d+1],f=g-a[d+3];switch(a[d+2]){case 0:c[l-1].x-=f;
c[l].x-=f;1===l&&(c[c.length-1].x-=f);l===c.length-1&&(c[0].x-=f);break;case 1:c[l-1].x+=f;c[l].x+=f;1===l&&(c[c.length-1].x+=f);l===c.length-1&&(c[0].x+=f);break;case 2:c[l-1].y-=f;c[l].y-=f;1===l&&(c[c.length-1].y-=f);l===c.length-1&&(c[0].y-=f);break;case 3:c[l-1].y+=f,c[l].y+=f,1===l&&(c[c.length-1].y+=f),l===c.length-1&&(c[0].y+=f)}}},e}()});