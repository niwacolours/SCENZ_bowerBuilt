//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../core/libs/gl-matrix/mat4 ../../../../core/libs/gl-matrix/vec3 ../../../../geometry/Point ../Container ../StageGL ../../engine/webgl/TileData ./enums ./GeometryUtils ./TextureManager ./Utils ./WGLPainter ./WGLRendererInfo".split(" "),function(q,r,v,w,x,y,l,n,z,A,B,t,p,C,D,u,E,F){Object.defineProperty(r,"__esModule",{value:!0});
q=function(m){function c(a){var b=m.call(this)||this;return b._rendererInfo=new F,b._stage=new B,b._container=null,b._tileCoordinateScale=n.create(),b._orientationVec=n.fromValues(0,0,1),b._displayScale=n.create(),b._defaultTransform=l.create(),b._pointToCallbacks=new Map,b._highlightIDs=new Set,b._tileId=void 0,b._patches={},b._displayWidth=0,b._displayHeight=0,b._highlightOptionsUpToDate=!1,b.layer=null,b.textureManager=new D,b.highlightOptions=a.highlightOptions,b.tileInfoView=a.tileInfoView,b._stage.useContextVersion("webgl"),
b.layer=a.layer,b._layerView=a.layerView,b}return w(c,m),c.prototype.dispose=function(){this.textureManager&&(this.textureManager.dispose(),this.textureManager=null);this.removeAllChildren();for(var a=0,b=this.children;a<b.length;a++)b[a].dispose()},c.prototype.disposeWebGLResources=function(){for(var a=0,b=this.children;a<b.length;a++)b[a].clear()},c.prototype.displayWidth=function(){return this._displayWidth},Object.defineProperty(c.prototype,"displayHeight",{get:function(){return this._displayHeight},
enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"highlightOptions",{get:function(){return this._highlightOptions},set:function(a){this._highlightOptions=a;this._highlightOptionsUpToDate=!1},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"visualVariablesInfo",{get:function(){return this._visualVariablesInfo},set:function(a){this._visualVariablesInfo=a;this.requestRender()},enumerable:!0,configurable:!0}),c.prototype.install=function(a){a.addChild(this._stage);this._stage.addChild(this);
this._container=a},c.prototype.uninstall=function(a){a.removeChild(this._stage);this._stage.removeChild(this);this.dispose();this._container=null},c.prototype.hitTest=function(a,b){var d=this,c=[a,b];return x.create(function(a,b){d._pointToCallbacks.set(c,{resolve:a,reject:b});d.requestRender()},function(){d._pointToCallbacks.has(c)&&d._pointToCallbacks.delete(c)})},c.prototype.highlight=function(a){var b=this;return b.addHighlight(a),{remove:function(){b.removeHighlight(a)}}},c.prototype.setHighlight=
function(a){this._highlightIDs.clear();this.addHighlight(a)},c.prototype.setVisibility=function(a,b){for(var d=0,c=this.children;d<c.length;d++)!function(d){if(d.data){var c=d.data.tileDisplayData.displayObjectRegistry,f=a.filter(function(a){return c.has(a.id)});d.setVisibility(f,b)}}(c[d])},c.prototype.setVisibilityRange=function(a,b,d,c){for(var e=0,h=this.children;e<h.length;e++){var f=h[e];f.data&&f.data.tileDisplayData.displayObjectRegistry.has(a)&&f.setVisibilityRange(a,b,d,c)}},c.prototype.addHighlight=
function(a){for(var b=0;b<a.length;b++)this._highlightIDs.add(a[b]);this._buildHLList()},c.prototype.removeHighlight=function(a){for(var b=0;b<a.length;b++)this._highlightIDs.delete(a[b]);this._buildHLList()},c.prototype.getMaterialItems=function(a){if(a&&0!==a.length){for(var b=[],d=0;d<a.length;d++){var c=a[d];b.push(this.textureManager.rasterizeItem(c.symbol,c.glyphIds))}return y.all(b).then(function(a){return a.map(function(a,b){return{id:b,mosaicItem:a}})})}},c.prototype.onTileData=function(a,
b){var d=null;b&&(d=t.decode(b));a.setData(d,null!=this.visualVariablesInfo.vvFields,this.layer.labelsVisible);a.buildHLList(this._highlightIDs);this._layerView&&this._layerView.view.labelManager.requestUpdate();this.addChild(a);this._stage.fadeInLabels();this.requestRender()},c.prototype.onTileDataUpdate=function(a,b){this._patches[a.key.id]=this._patches[a.key.id]||[];this._patches[a.key.id].push({tile:a,patch:b});this._stage.fadeInLabels();this.requestRender()},c.prototype.onTileError=function(a){a.clear();
a.buildHLList(this._highlightIDs);this.addChild(a);this.requestRender()},c.prototype.addChild=function(a){var b=m.prototype.addChild.call(this,a);return this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.addTile(this.layer.uid,a),this._buildHLList(),b},c.prototype.removeChild=function(a){var b=m.prototype.removeChild.call(this,a);return this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.removeTile(this.layer.uid,a.key.id),this._buildHLList(),b},c.prototype.prepareChildrenRenderParameters=
function(a){this._rendererInfo.updateVisualVariables(this._visualVariablesInfo.vvRanges,a.state);var b=this.tileInfoView.getClosestInfoForScale(a.state.scale).level,d=this.tileInfoView.tileInfo.scaleToZoom(a.state.scale);return v({},a,{rendererInfo:this._rendererInfo,requiredLevel:b,displayLevel:d})},c.prototype.renderChildren=function(a){for(var b=this,d=0;this._nextTile()&&4>d;){for(var c=0,e=this._patches[this._tileId];c<e.length;c++){var g=e[c];this._patchTileVisuals(g.tile,g.patch)}delete this._patches[this._tileId];
++d}d=a.painter;d.bindTextureManager(this.textureManager);this._rendererInfo.updateVisualVariables(this._visualVariablesInfo.vvRanges,a.state);this.sortChildren(function(a,b){return 0!=a.key.level-b.key.level?a.key.level-b.key.level:0!=a.key.row-b.key.row?a.key.row-b.key.row:a.key.col-b.key.col});c=E.default.toWGLDrawPhases(a.drawPhase);if(0<c.length&&c[0]===p.WGLDrawPhase.LABEL||c[0]===p.WGLDrawPhase.LABEL_ALPHA){e=this.layer;if(!(e.labelsVisible&&e.labelingInfo&&0<e.labelingInfo.length))return;
this._updateTilesTransform(a.state,a.requiredLevel);d.update(a.state,a.pixelRatio)}d.draw(a,this.children,c,this._painterOptions);0<this._highlightIDs.size&&d.highlight(a,this.children);0!==this._pointToCallbacks.size&&(this._pointToCallbacks.forEach(function(c,d){c.resolve(b._hitTest(a,d[0],d[1]))}),this._pointToCallbacks.clear())},c.prototype.attachChild=function(a,b){return a.attach(b)},c.prototype.detachChild=function(a,b){a.detach(b)},c.prototype.renderChild=function(a,b){a.doRender(b)},c.prototype.beforeRenderChildren=
function(a,b){this._updateTilesTransform(a.state,this.tileInfoView.getClosestInfoForScale(a.state.scale).level);this._updateHighlightOptions();this._stage.opacity=this._container.opacity},c.prototype._hitTest=function(a,b,c){var d=a.painter,e=a.requiredLevel,g=[0,0];a.state.toMap(g,[b,c]);b=a.state.clone();c=b.viewpoint.clone();return c.targetGeometry=new z(g[0],g[1],a.state.spatialReference),b.viewpoint=c,b.size=[u.C_HITTEST_SEARCH_SIZE,u.C_HITTEST_SEARCH_SIZE],this._updateTilesTransform(b,e),d.update(b,
a.pixelRatio),d.hitTest({context:a.context,drawPhase:p.WGLDrawPhase.HITTEST,painter:d,pixelRatio:a.pixelRatio,displayLevel:a.displayLevel,rendererInfo:this._rendererInfo,requiredLevel:e,state:b,stationary:a.stationary},this.children)},c.prototype._updateTilesTransform=function(a,b){var c=1/a.width,h=1/a.height,e=[0,0];this._calculateRelativeViewProjMat(this.tileInfoView.tileInfo.lods[b].resolution,a.resolution,a.rotation,this.tileInfoView.tileInfo.size[0],a.width,a.height,this._defaultTransform);
for(var g=0,f=this.children;g<f.length;g++){var k=f[g];a.toScreen(e,k.coords);e[1]=a.height-e[1];k.tileTransform.displayCoord[0]=2*e[0]*c-1;k.tileTransform.displayCoord[1]=2*e[1]*h-1;k.key.level===b?k.tileTransform.transform.set(this._defaultTransform):this._calculateRelativeViewProjMat(this.tileInfoView.tileInfo.lods[k.key.level].resolution,a.resolution,a.rotation,this.tileInfoView.tileInfo.size[0],a.width,a.height,k.tileTransform.transform)}},c.prototype._calculateRelativeViewProjMat=function(a,
b,c,h,e,g,f){a/=b;this._tileCoordinateScale.set([a,a,1]);e===this._displayWidth&&g===this._displayHeight||(this._displayScale.set([2/e,-2/g,1]),this._displayWidth=e,this._displayHeight=g);l.identity(f);l.scale(f,f,this._tileCoordinateScale);l.rotate(f,f,-c*C.C_DEG_TO_RAD,this._orientationVec);l.scale(f,f,this._displayScale);l.transpose(f,f)},c.prototype._updateHighlightOptions=function(){if(!this._highlightOptionsUpToDate&&this.parent){var a=this.parent.glPainter,b=this._highlightOptions;if(a){var c=
b.color.toRgba();c[0]/=255;c[1]/=255;c[2]/=255;var h=c.slice();c[3]*=b.fillOpacity;h[3]*=b.haloOpacity;a.setHighlightOptions({fillColor:c,outlineColor:h,outlineWidth:2,outerHaloWidth:.3,innerHaloWidth:.3,outlinePosition:0})}}},c.prototype._buildHLList=function(){for(var a=0,b=this.children;a<b.length;a++)b[a].buildHLList(this._highlightIDs);this.requestRender()},c.prototype._nextTile=function(){var a=Object.keys(this._patches);if(0===a.length)return this._tileId=void 0,!1;if(!this._tileId)return this._tileId=
a[0],!0;var b=a.indexOf(this._tileId);return b=(b+1)%a.length,this._tileId=a[b],!0},c.prototype._patchTileVisuals=function(a,b){var c=b.addOrUpdate?t.decode(b.addOrUpdate):null;a.patchData({remove:b.remove||[],addOrUpdate:c},this.layer.labelsVisible);a.buildHLList(this._highlightIDs);this.contains(a)||this.addChild(a)},c}(A);r.default=q});