//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../enums ../Utils ./WGLGeometryBrush ../../../../webgl/Texture ../../../../webgl/VertexArrayObject".split(" "),function(p,q,r,t,u,v,w,m){Object.defineProperty(q,"__esModule",{value:!0});p=function(n){function f(){var b=null!==n&&n.apply(this,arguments)||this;return b._iconAttributeLocations={a_pos:0,a_vertexOffsetAndTex:1,a_id:2,a_color:3,a_outlineColor:4,a_sizeAndOutlineWidth:5},b._iconAttributeLocationsVV={a_pos:0,a_vertexOffsetAndTex:1,
a_id:2,a_color:3,a_outlineColor:4,a_sizeAndOutlineWidth:5,a_vv:6},b._iconAttributeLocationsHeatmap={a_pos:0,a_vertexOffsetAndTex:1,a_id:2,a_color:3,a_outlineColor:4,a_sizeAndOutlineWidth:5,a_weight:6},b._iconVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffsetAndTex",count:4,type:5120,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:8,stride:24,normalized:!0,divisor:0},{name:"a_color",count:4,
type:5121,offset:12,stride:24,normalized:!0,divisor:0},{name:"a_outlineColor",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_sizeAndOutlineWidth",count:4,type:5121,offset:20,stride:24,normalized:!1,divisor:0}]},b._iconVertexAttributesWithVV={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:40,normalized:!1,divisor:0},{name:"a_vertexOffsetAndTex",count:4,type:5120,offset:4,stride:40,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:8,stride:40,normalized:!0,
divisor:0},{name:"a_color",count:4,type:5121,offset:12,stride:40,normalized:!0,divisor:0},{name:"a_outlineColor",count:4,type:5121,offset:16,stride:40,normalized:!0,divisor:0},{name:"a_sizeAndOutlineWidth",count:4,type:5121,offset:20,stride:40,normalized:!1,divisor:0},{name:"a_vv",count:4,type:5126,offset:24,stride:40,normalized:!1,divisor:0}]},b._iconVertexAttributesWithHeatmap={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:28,normalized:!1,divisor:0},{name:"a_vertexOffsetAndTex",count:4,
type:5120,offset:4,stride:28,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:8,stride:28,normalized:!0,divisor:0},{name:"a_color",count:4,type:5121,offset:12,stride:28,normalized:!0,divisor:0},{name:"a_outlineColor",count:4,type:5121,offset:16,stride:28,normalized:!0,divisor:0},{name:"a_sizeAndOutlineWidth",count:4,type:5121,offset:20,stride:28,normalized:!1,divisor:0},{name:"a_weight",count:1,type:5126,offset:24,stride:28,normalized:!1,divisor:0}]},b._spritesTextureSize=new Float32Array(2),
b}return r(f,n),f.prototype.dispose=function(){},f.prototype.getGeometryType=function(){return t.WGLGeometryType.MARKER},f.prototype.drawGeometry=function(b,d,e,g){g=b.context;var h=b.painter,a=b.rendererInfo,c=b.drawPhase;b=e.indexCount;var x=e.indexFrom,k=e.materialInfo;e=k.materialKeyInfo;var l=e.heatmap,f=e.hasVV()?this._iconAttributeLocationsVV:this._iconAttributeLocations;if(c=h.materialManager.getProgram(k.materialKey,c,f))g.bindProgram(c),f=this._getVAO(g,d,e.hasVV(),l),(g.bindVAO(f),l)?(k=
this._getIntensityTexture(g,a.heatmapParameters),g.bindTexture(k,1),c.setUniform1i("u_texture",1),this._spritesTextureSize[0]=Math.round(a.heatmapParameters.radius),this._spritesTextureSize[1]=Math.round(a.heatmapParameters.radius)):(l=k.texBindingInfo[0],k=l.pageId,h.textureManager.bindSpritePage(g,k,l.unit),c.setUniform1i(l.semantic,l.unit),l=h.textureManager.sprites,this._spritesTextureSize[0]=l.getWidth(k)/4,this._spritesTextureSize[1]=l.getHeight(k)/4),h=a.vvMaterialParameters.vvRotationEnabled&&
"geographic"===a.vvMaterialParameters.vvRotationType?h.extrudeMatrix:h.extrudeNoRotationMatrix,c.setUniformMatrix4fv("u_transformMatrix",d.tileTransform.transform),c.setUniformMatrix4fv("u_extrudeMatrix",h),c.setUniform2fv("u_normalized_origin",d.tileTransform.displayCoord),c.setUniform2fv("u_mosaicSize",this._spritesTextureSize),c.setUniform1f("u_opacity",1),e.vvSizeMinMaxValue&&c.setUniform4fv("u_vvSizeMinMaxValue",a.vvSizeMinMaxValue),e.vvSizeScaleStops&&c.setUniform1f("u_vvSizeScaleStopsValue",
a.vvSizeScaleStopsValue),e.vvSizeFieldStops&&(c.setUniform1fv("u_vvSizeFieldStopsValues",a.vvSizeFieldStopsValues),c.setUniform1fv("u_vvSizeFieldStopsSizes",a.vvSizeFieldStopsSizes)),e.vvSizeUnitValue&&c.setUniform1f("u_vvSizeUnitValueWorldToPixelsRatio",a.vvSizeUnitValueToPixelsRatio),e.vvColor&&(c.setUniform1fv("u_vvColorValues",a.vvColorValues),c.setUniform4fv("u_vvColors",a.vvColors)),e.vvOpacity&&(c.setUniform1fv("u_vvOpacityValues",a.vvOpacityValues),c.setUniform1fv("u_vvOpacities",a.vvOpacities)),
e.vvRotation&&c.setUniform1f("u_vvRotationType","geographic"===a.vvMaterialParameters.vvRotationType?0:1),g.drawElements(4,b,5125,4*x),g.bindVAO(null)},f.prototype._getVAO=function(b,d,e,g){if(d.iconGeometry.vao)return d.iconGeometry.vao;var h=d.iconGeometry.vertexBufferMap[u.C_VBO_GEOMETRY],a=d.iconGeometry.indexBuffer;return h&&a?(d.iconGeometry.vao=e?new m(b,this._iconAttributeLocationsVV,this._iconVertexAttributesWithVV,{geometry:h},a):g?new m(b,this._iconAttributeLocationsHeatmap,this._iconVertexAttributesWithHeatmap,
{geometry:h},a):new m(b,this._iconAttributeLocations,this._iconVertexAttributes,{geometry:h},a),d.iconGeometry.vao):null},f.prototype._getIntensityTexture=function(b,d){if(d.intensityKernel&&!d.refreshIntensityKernel)return d.intensityKernel;d.intensityKernel&&(d.intensityKernel.dispose(),d.intensityKernel=null);for(var e=d.radius,g=d.kernelSize,h=d.blurRadius,a=e*e,c=[],f=-1;++f<g;)c[f]=Math.exp(-Math.pow(f-h,2)/(2*a))/(e/2*Math.sqrt(2*Math.PI));for(var k=[],l=0;l<g;l++)for(h=c[l],f=0;f<g;f++)a=
l*g+f,e=c[f],k[4*a+0]=h*e,k[4*a+1]=0,k[4*a+2]=0,k[4*a+3]=1;b=new w(b,{target:3553,pixelFormat:6408,internalFormat:b.capabilities.colorBufferFloat.RGBA32F,dataType:5126,samplingMode:b.capabilities.textureFloatLinear?9729:9728,wrapMode:33071,width:g,height:g},new Float32Array(k));return d.intensityKernel=b,d.refreshIntensityKernel=!1,b},f}(v.default);q.default=p});