//>>built
define("require exports ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(y,z,u,v,w,k,r){var m=new k("0/0/0/0"),x=function(){function d(b,a,c,e,g,t,d,f){this.x=b;this.ymin=a;this.ymax=c;this.invM=e;this.leftAdjust=g;this.rightAdjust=t;this.leftBound=d;this.rightBound=f}return d.create=function(b,a){b[1]>a[1]&&(f=[a,b],b=f[0],a=f[1]);f=b[0];b=b[1];var c=a[0];a=a[1];var e=c-f,g=a-b,g=0!==g?e/g:0,t=(Math.ceil(b)-b)*g,n=(Math.floor(b)-b)*
g;return new d(f,Math.floor(b),Math.ceil(a),g,0>e?t:n,0>e?n:t,0>e?c:f,0>e?f:c);var f},d.prototype.incrRow=function(){this.x+=this.invM},d.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},d.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},d}(),f=[[0,0],[0,0],[0,0],[0,0]];return function(){function d(b,a){var c=this;this.tileInfo=b;this.fullExtent=a;this.scales=[];this._lodInfos=null;this._infoByScale={};this._infoByLevel=
{};var e=b.lods.slice();e.sort(function(a,b){return b.scale-a.scale});var g=this._lodInfos=e.map(function(c){return v.create(b,c,a)});e.forEach(function(a,b){c._infoByLevel[a.level]=g[b];c._infoByScale[a.scale]=g[b];c.scales[b]=a.scale},this);this._wrap=b.isWrappable}return d.prototype.getLODInfoAt=function(b){return this._infoByLevel[b.level]},d.prototype.getTileBounds=function(b,a,c){void 0===c&&(c=!1);m.set(a);return(a=this._infoByLevel[m.level])?a.getTileBounds(b,m,c):b},d.prototype.getTileCoords=
function(b,a,c){void 0===c&&(c=!1);m.set(a);return(a=this._infoByLevel[m.level])?a.getTileCoords(b,m,c):b},d.prototype.getTileCoverage=function(b,a,c){void 0===a&&(a=192);void 0===c&&(c="closest");var e,g,d;c="closest"===c?this.getClosestInfoForScale(b.scale):this.getSmallestInfoForScale(b.scale);var k=w.pool.acquire(c),m=this._wrap;e=1/0;var q=-1/0,p=k.spans;f[0][0]=f[0][1]=f[1][1]=f[3][0]=-a;f[1][0]=f[2][0]=b.size[0]+a;f[2][1]=f[3][1]=b.size[1]+a;for(a=0;a<f.length;a++){var h=f[a];b.toMap(h,h);
h[0]=c.getColumnForX(h[0]);h[1]=c.getRowForY(h[1])}b=[];h=3;for(a=0;4>a;a++){if(f[a][1]!==f[h][1]){var l=x.create(f[a],f[h]);e=Math.min(l.ymin,e);q=Math.max(l.ymax,q);void 0===b[l.ymin]&&(b[l.ymin]=[]);b[l.ymin].push(l)}h=a}if(null==e||null==q||100<q-e)return null;for(h=[];e<q;){null!=b[e]&&(h=h.concat(b[e]));g=1/0;d=-1/0;for(a=h.length-1;0<=a;a--)l=h[a],g=Math.min(g,l.getLeftCol()),d=Math.max(d,l.getRightCol());if(g=Math.floor(g),d=Math.floor(d),e>=c.first[1]&&e<=c.last[1])if(m)if(c.size[0]<c.worldSize[0])for(l=
Math.floor(d/c.worldSize[0]),a=Math.floor(g/c.worldSize[0]);a<=l;a++)p.push(new r(e,Math.max(c.getFirstColumnForWorld(a),g),Math.min(c.getLastColumnForWorld(a),d)));else p.push(new r(e,g,d));else g>c.last[0]||d<c.first[0]||(g=Math.max(g,c.first[0]),d=Math.min(d,c.last[0]),p.push(new r(e,g,d)));e+=1;for(a=h.length-1;0<=a;a--)l=h[a],l.ymax>=e?l.incrRow():h.splice(a,1)}return k},d.prototype.getTileIdAtParent=function(b,a){a=k.pool.acquire(a);var c=this._infoByLevel[a.level];if(b.resolution<c.resolution)throw Error("Cannot calculate parent tile. destination LOD's resolution "+
b.resolution+" is not a parent resolution of "+c.resolution);return b.resolution===c.resolution?a.id:k.getId(b.level,Math.floor(a.row*c.resolution/b.resolution+.01),Math.floor(a.col*c.resolution/b.resolution+.01),a.world)},d.prototype.getTileParentId=function(b){b=k.pool.acquire(b);var a=this._lodInfos.indexOf(this._infoByLevel[b.level])-1;if(0>a)return k.pool.release(b),null;a=this.getTileIdAtParent(this._lodInfos[a],b);return k.pool.release(b),a},d.prototype.getTileResolution=function(b){return(b=
this._infoByLevel[b.level])?b.resolution:-1},d.prototype.getTileScale=function(b){return(b=this._infoByLevel[b.level])?b.scale:-1},d.prototype.intersects=function(b,a){var c=k.pool.acquire(a);a=this._infoByLevel[c.level];var e=b.lodInfo;if(e.resolution>a.resolution){var d=k.pool.acquire(this.getTileIdAtParent(e,c)),f=e.denormalizeCol(d.col,d.world);a=b.spans.some(function(a){return a.row===d.row&&a.colFrom<=f&&a.colTo>=f});return k.pool.release(c),k.pool.release(d),a}if(e.resolution<a.resolution){var n=
b.spans.reduce(function(a,b){return a[0]=Math.min(a[0],b.row),a[1]=Math.max(a[1],b.row),a[2]=Math.min(a[2],b.colFrom),a[3]=Math.max(a[3],b.colTo),a},[1/0,-1/0,1/0,-1/0]);b=n[0];var m=n[1],q=n[2],n=n[3],p=a.denormalizeCol(c.col,c.world),h=e.getColumnForX(a.getXForColumn(p)),l=e.getRowForY(a.getYForRow(c.row)),p=e.getColumnForX(a.getXForColumn(p+1))-1;a=e.getRowForY(a.getYForRow(c.row+1))-1;return k.pool.release(c),!(h>n||p<q||l>m||a<b)}var r=e.denormalizeCol(c.col,c.world);a=b.spans.some(function(a){return a.row===
c.row&&a.colFrom<=r&&a.colTo>=r});return k.pool.release(c),a},d.prototype.normalizeBounds=function(b,a,c){if(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],this._wrap)a=u.getInfo(this.tileInfo.spatialReference),c=-c*(a.valid[1]-a.valid[0]),b[0]+=c,b[2]+=c;return b},d.prototype.getSmallestInfoForScale=function(b){var a=this.scales;if(this._infoByScale[b])return this._infoByScale[b];if(b>a[0])return this._infoByScale[a[0]];for(var c=1;c<a.length-1;c++)if(b>a[c])return this._infoByScale[a[c-1]];return this._infoByScale[a[a.length-
1]]},d.prototype.getClosestInfoForScale=function(b){var a=this.scales;return this._infoByScale[b]?this._infoByScale[b]:(b=a.reduce(function(a,d,f,k){return Math.abs(d-b)<Math.abs(a-b)?d:a},a[0]),this._infoByScale[b])},d}()});