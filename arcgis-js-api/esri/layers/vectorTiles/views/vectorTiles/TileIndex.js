//>>built
define(["require","exports","../../core/promiseUtils","../../layers/support/TilemapCache","../2d/tiling/TileKey"],function(l,m,g,k,h){return function(){function f(a){if(a instanceof k)this._tilemapCache=a;else{if(!(a&&"index"in a))throw Error("Invalid tilemap!");this._tilemap=a.index}}return f.prototype.dataKey=function(a){if(this._tilemapCache){var b=a.level,d=a.row,c=a.col,e=new h(a);return this._tilemapCache.fetchAvailabilityUpsample(b,d,c,e).then(function(){return e}).catch(function(a){if(a&&
"cancel"===a.dojoType)throw a;return e.level=b,e.row=d,e.col=c,e})}return this._getIndexedDataKey(a)},f.prototype.forEach=function(a,b,d,c,e){this._callback=e;this._maxLevel=b+a;this._forEach(this._tilemap,b,d,c)},f.prototype._forEach=function(a,b,d,c){0!==a&&(this._callback(b,d,c),b!==this._maxLevel&&"object"==typeof a&&(this._forEach(a[0],b+1,2*d,2*c),this._forEach(a[1],b+1,2*d,2*c+1),this._forEach(a[2],b+1,2*d+1,2*c),this._forEach(a[3],b+1,2*d+1,2*c+1)))},f.prototype._getIndexedDataKey=function(a){var b=
[a];if(0>a.level||0>a.row||0>a.col||0<a.row>>a.level||0<a.col>>a.level)return g.resolve(null);for(;0!==a.level;)a=new h(a.level-1,a.row>>1,a.col>>1,a.world),b.push(a);var d,c=this._tilemap,e=b.pop();if(1===c)return g.resolve(e);for(;b.length;)if(d=b.pop(),a=(1&d.col)+((1&d.row)<<1),c){if(0===c[a]){e=null;break}if(1===c[a]){e=d;break}e=d;c=c[a]}return g.resolve(e)},f}()});