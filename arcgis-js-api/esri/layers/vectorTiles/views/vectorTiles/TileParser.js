//>>built
define("require exports dojo/promise/all ../../core/executeAsync ../../core/pbf ../../core/promiseUtils ../2d/engine/webgl/TileClipper ../2d/tiling/enums ./BackgroundBucket ./CircleBucket ./Feature ./FillBucket ./LineBucket ./SourceLayerData ./SymbolBucket".split(" "),function(T,U,M,G,y,H,n,u,z,N,O,P,Q,R,S){return function(){function c(a,b,e){this._pbfTile=new y(new Uint8Array(a),new DataView(a));this._tile=b;this._connection=e;this._layers=b.getLayers();e=b.tileKey.split("/").map(parseFloat);var c=
e[0];a=e[1];e=e[2];if(this._level=c,b.refKey)b=b.refKey.split("/").map(parseFloat)[0],b=c-b,0<b&&(c=(1<<b)-1,this._tileClipper=new n.TileClipper(b,a&c,e&c));this._tileClipper||(this._tileClipper=new n.SimpleBuilder)}return c.prototype.parse=function(){for(var a,b=this,c=this._parseTileData(this._pbfTile),n=this._layers,h=n.length,I=this._level,l=[],p={},J=new Set,h=h-1;0<=h;h--)if(a=n[h],!(a.minzoom&&I<a.minzoom||a.maxzoom&&I>=a.maxzoom||a.layout&&"none"===a.layout.visibility))if(0!==a.type){var v=
a.sourceLayer,q=c[v];if(q){J.add(v);var k=this._createBucket(a);k&&(k.layerIndex=h,k.layerExtent=q.extent,(q=p[v])||(q=p[v]=[]),q.push(k))}}else k=this._createBucket(a),k.layerIndex=h,l.push(k);var y=10*this._level,z=10*(this._level+1),r=[],A=[],w=[],K=[],B=this._tileClipper,C=new Set,D={},E=[];J.forEach(function(b){return E.push(b)});var x=0,t=0,F=E.length;return G(function(){if(b._tile.status===u.TileStatus.INVALID)return!0;switch(x){case 0:if(t<F){var a=E[t++],e=c[a],m=p[a];if(m&&0!==m.length)for(a=
e.getData();a.next(2);){var f=new O(a.getMessage(),e),d=f.values;if(d){var g=d._minzoom;if(g&&g>=z)continue;if((d=d._maxzoom)&&d<=y)continue}for(var g=0,L=m;g<L.length;g++)d=L[g],d.pushFeature(f)}}else{e=b._tile;for(a in p)for(m=p[a],f=0;f<m.length;f++)d=m[f],d.hasFeatures()&&(3===d.layer.type?(r.push(d),e.addBucket(d)):d.layer.refLayerId?w.push(d):(A.push(d),K[d.layer.id]=d));x=1;t=0;F=r.length}break;case 1:t<F?r[t++].getResources(B,C,D):x=2}return 2===x}).then(function(){if(b._tile.status===u.TileStatus.INVALID)return[];
var a,c=[],e=b._tile.getWorkerTileHandler();0<C.size&&(a=e.fetchSprites(C,b._connection),c.push(a));var f,d;for(d in D)a=D[d],0<a.size&&(f=e.fetchGlyphs(b._tile.tileKey,d,a,b._connection),c.push(f));return M(c).then(function(a){if(b._tile.status===u.TileStatus.INVALID)return[];var c=0,d=0,e=A.length;return G(function(){if(b._tile.status===u.TileStatus.INVALID)return!0;switch(c){case 0:if(d<e){var a=A[d++];a.processFeatures(B,b._tile);l.push(a)}else c=1,d=0,e=w.length;break;case 1:for(var f=0;f<w.length;f++){var a=
w[f],g=K[a.layer.refLayerId];g&&(g.assignBufferInfo(a),l.push(a))}c=2;d=0;e=r.length;break;case 2:d<e?(a=r[d++],a.processFeatures(B,b._tile),l.push(a)):c=3}return 3===c}).then(function(){return l.sort(function(a,b){return a.layerIndex-b.layerIndex}),l})}).catch(function(a){return H.reject(Error(a))})}).catch(function(a){return H.reject(Error(a))})},c.prototype._parseTileData=function(a){for(var b={};a.next();)switch(a.tag()){case 3:var c=new R(a.getMessage());b[c.name]=c;break;default:a.skip()}return b},
c.prototype._createBucket=function(a){switch(a.type){case 0:return this._createBackgroundBucket(a);case 1:return this._createFillBucket(a);case 2:return this._createLineBucket(a);case 4:return this._createCircleBucket(a);case 3:return this._createSymbolBucket(a)}},c.prototype._createBackgroundBucket=function(a){return new z(a,this._level)},c.prototype._createFillBucket=function(a){var b=this._tile;return new P(a,this._level,a.hasDataDrivenFill?b.fillDDVertexBuffer:b.fillVertexBuffer,b.fillIndexBuffer,
a.hasDataDrivenOutline?b.outlineDDVertexBuffer:b.outlineVertexBuffer,b.outlineIndexBuffer)},c.prototype._createLineBucket=function(a){var b=this._tile;return new Q(a,this._level,a.hasDataDrivenLine?b.lineDDVertexBuffer:b.lineVertexBuffer,b.lineIndexBuffer)},c.prototype._createCircleBucket=function(a){var b=this._tile;return new N(a,this._level,b.circleVertexBuffer,b.circleIndexBuffer)},c.prototype._createSymbolBucket=function(a){var b=this._tile;return new S(a,this._level,a.hasDataDrivenIcon?b.iconDDVertexBuffer:
b.iconVertexBuffer,b.iconIndexBuffer,a.hasDataDrivenText?b.textDDVertexBuffer:b.textVertexBuffer,b.textIndexBuffer,b.placementEngine,b.getWorkerTileHandler())},c}()});