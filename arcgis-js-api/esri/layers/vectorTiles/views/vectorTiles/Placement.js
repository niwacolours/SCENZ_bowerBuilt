//>>built
define(["require","exports","../2d/engine/webgl/Geometry","./Conflict","./GeometryUtils"],function(C,D,r,F,d){Object.defineProperty(D,"__esModule",{value:!0});C=function(){return function(d,a,g,b,e){void 0===g&&(g=0);void 0===b&&(b=-1);void 0===e&&(e=E);this.x=d;this.y=a;this.angle=g;this.segment=b;this.minzoom=e}}();D.Anchor=C;var Q=function(){return function(k,a,g,b,e,f,l){void 0===e&&(e=!1);void 0===f&&(f=E);void 0===l&&(l=d.C_INFINITY);this.anchor=k;this.labelAngle=a;this.glyphAngle=g;this.page=
b;this.upsideDown=e;this.minzoom=f;this.maxzoom=l}}(),R=function(){return function(d,a,g,b,e,f,l,r,x,t){this.tl=d;this.tr=a;this.bl=g;this.br=b;this.mosaicRect=e;this.labelAngle=f;this.anchor=l;this.minzoom=r;this.maxzoom=x;this.page=t}}();D.PlacedSymbol=R;var S=function(){return function(d,a){this.footprint=d;this.shapes=a}}();D.Placement=S;var E=.5;C=function(){function k(){this.mapAngle=0;this._conflictEngine=new F.ConflictEngine}return k.prototype.reset=function(){this._conflictEngine.reset()},
k.prototype.setAngle=function(a){this.mapAngle=a;this._conflictEngine.setAngle(a)},k.prototype.getIconPlacement=function(a,g,b,e,f,l,k){var x=b.width/b.pixelRatio,t=b.height/b.pixelRatio;f=l.offset[0]-x/2;var y=l.offset[1]-t/2,x=f+x,t=y+t,z=b.rect,n=b.sdf?17:2,h=f-n,c=y-n,m=h+z.width/b.pixelRatio,p=c+z.height/b.pixelRatio;b=new r.Point(h,c);n=new r.Point(m,p);p=new r.Point(h,p);c=new r.Point(m,c);m=l.rotate*d.C_DEG_TO_RAD;h=1===l.rotationAlignment;if(0<=a.segment&&!h&&(m+=a.angle),0!==m){var q=Math.cos(m),
u=Math.sin(m);b.rotate(q,u);n.rotate(q,u);p.rotate(q,u);c.rotate(q,u)}q=8*l.padding;u=new r.Point(a.x,a.y);a=new F.Footprint(this.mapAngle,q,h);a.addBox(u,new F.Box(f,y,x,t),e,m,g,E,d.C_INFINITY);g=new R(b,c,p,n,z,0,u,E,d.C_INFINITY,0);g=new S(a,[g]);e=E;return l.allowOverlap||(e=this._conflictEngine.getMinZoom(g.footprint,e,k,h)),a.minzoom=e,g},k.prototype.getTextPlacement=function(a,g,b,e,f,l,k,x){for(var t,y=new r.Point(a.x,a.y),z=k.rotate*d.C_DEG_TO_RAD,n=0===k.rotationAlignment,h=k.keepUpright,
c=E,m=!n,p=m?0:a.angle,q=0<=a.segment&&n,u=new F.Footprint(this.mapAngle,8*k.padding,m),D=[],C=!q,G=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,K=G,L=H,da=q?h:n&&h,T=0;T<e.length;T++){var A=e[T],v=A.glyphMosaicItem;if(v&&!v.rect.isEmpty){var U=v.rect,I=v.metrics,B=v.page;C&&(t&&t!==A.y&&(u.addBox(y,new F.Box(G,K,H,L),f,z,g,E,d.C_INFINITY),G=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,K=G,L=H),t=A.y);var J=[];if(q){if(v=(b.x+A.x+I.left-4+.5*v.metrics.width)*f,c=this._placeGlyph(a,c,
v,l,a.segment,1,B,J),h&&(c=this._placeGlyph(a,c,v,l,a.segment,-1,B,J)),2<=c)break}else J.push(new Q(y,p,p,B)),n&&h&&J.push(new Q(y,p+d.C_PI,p+d.C_PI,B,!0));for(var B=A.x+b.x+I.left,A=A.y+b.y-I.top,v=B+I.width,I=A+I.height,M=new r.Point(B-4,A-4),V=new r.Point(M.x+U.width,M.y+U.height),ea=new r.Point(M.x,V.y),fa=new r.Point(V.x,M.y),W=0;W<J.length;W++){var w=J[W],Z=M.clone(),aa=ea.clone(),ba=fa.clone(),ca=V.clone(),X=A,Y=I,N=w.glyphAngle+z;if(0!==N){var O=Math.cos(N),P=Math.sin(N);Z.rotate(O,P);ca.rotate(O,
P);aa.rotate(O,P);ba.rotate(O,P)}D.push(new R(Z,ba,aa,ca,U,w.labelAngle,w.anchor,w.minzoom,w.maxzoom,w.page));da&&!this._legible(w.labelAngle)||(C?(B<G&&(G=B),X<K&&(K=X),v>H&&(H=v),Y>L&&(L=Y)):2>w.minzoom&&u.addBox(w.anchor,new F.Box(B,X,v,Y),f,N,g,w.minzoom,w.maxzoom))}}}if(2<=c)return null;C&&u.addBox(y,new F.Box(G,K,H,L),f,z,g,E,d.C_INFINITY);a=new S(u,D);return k.allowOverlap||(c=this._conflictEngine.getMinZoom(a.footprint,c,x,m)),u.minzoom=c,a},k.prototype.add=function(a){this._conflictEngine.add(a.footprint)},
k.prototype._legible=function(a){a=d.radToByte(a);return 65>a||193<=a},k.prototype._placeGlyph=function(a,g,b,e,f,l,k,x){var t=0>l?d.positiveMod(a.angle+d.C_PI,d.C_2PI):a.angle,y=this._legible(t),z=0;0>b&&(l*=-1,b*=-1,z=d.C_PI);0<l&&++f;a=new r.Point(a.x,a.y);var n=e[f],h=d.C_INFINITY;if(e.length<=f)return h;for(;;){var c=n.x-a.x,m=n.y-a.y,p=Math.sqrt(c*c+m*m),q=Math.max(b/p,g),c=d.positiveMod(Math.atan2(m/p,c/p)+z,d.C_2PI);if(x.push(new Q(a,t,c,k,y,q,h)),q<=g)return q;a=n.clone();do{if(f+=l,e.length<=
f||0>f)return q;n=e[f]}while(a.isEqual(n));h=n.x-a.x;c=n.y-a.y;m=Math.sqrt(h*h+c*c);h*=p/m;c*=p/m;a.x-=h;a.y-=c;h=q}},k}();D.PlacementEngine=C});