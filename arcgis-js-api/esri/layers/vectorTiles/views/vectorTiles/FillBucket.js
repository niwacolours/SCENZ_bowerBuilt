//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ../../core/ArrayPool ../../core/libs/earcut/earcut ../2d/engine/webgl/Geometry ./Bucket".split(" "),function(F,G,C,H,y,D,z,E){return function(B){function k(b,a,f,c,g,m){a=B.call(this,b,a)||this;if(b.hasDataDrivenFill!==f.isDataDriven())throw Error("incompatible fill buffer");if(b.hasDataDrivenOutline!==g.isDataDriven())throw Error("incompatible outline buffer");return a._fillVertexBuffer=f,a._fillIndexBuffer=
c,a._outlineVertexBuffer=g,a._outlineIndexBuffer=m,a}return C(k,B),Object.defineProperty(k.prototype,"fillIndexStart",{get:function(){return this._fillIndexStart},enumerable:!0,configurable:!0}),Object.defineProperty(k.prototype,"fillIndexCount",{get:function(){return this._fillIndexCount},enumerable:!0,configurable:!0}),Object.defineProperty(k.prototype,"outlineIndexStart",{get:function(){return this._outlineIndexStart},enumerable:!0,configurable:!0}),Object.defineProperty(k.prototype,"outlineIndexCount",
{get:function(){return this._outlineIndexCount},enumerable:!0,configurable:!0}),k.prototype.assignBufferInfo=function(b){b._fillIndexStart=this._fillIndexStart;b._fillIndexCount=this._fillIndexCount;b.layer.getPaintProperty("fill-outline-color")?(b._outlineIndexStart=this._outlineIndexStart,b._outlineIndexCount=this._outlineIndexCount):(b._outlineIndexStart=0,b._outlineIndexCount=0)},k.prototype.processFeatures=function(b,a){this._fillIndexStart=this._fillIndexBuffer.index;this._fillIndexCount=0;
this._outlineIndexStart=this._outlineIndexBuffer.index;this._outlineIndexCount=0;a=this.layer;var f=this.zoom,c=a.hasDataDrivenFill,g=a.hasDataDrivenOutline;b&&b.setExtent(this.layerExtent);var m=a.getPaintValue("fill-pattern",f),d=a.getPaintValue("fill-antialias",f)&&void 0===m,k=[1,1,1,1],q=[1,1,1,1],n=1;if(a.outlineUsesFillColor){if(d&&!a.hasDataDrivenOpacity){var p=a.getPaintValue("fill-opacity",f),h=a.getPaintValue("fill-opacity",f+1);1>p&&1>h&&(d=!1)}d&&!a.hasDataDrivenColor&&(p=a.getPaintValue("fill-color",
f),h=a.getPaintValue("fill-color",f+1),1>p[3]&&1>h[3]&&(d=!1))}p=0;for(h=this._features;p<h.length;p++){var e=h[p];!m&&a.hasDataDrivenColor&&(k=a.getPaintValue("fill-color",f,e));a.hasDataDrivenOpacity&&(n=a.getPaintValue("fill-opacity",f,e));!m&&a.hasDataDrivenOutlineColor&&(q=a.getPaintValue("fill-outline-color",f,e));var l=void 0;c&&(l={color:k,opacity:n});var r=void 0;g&&(r={color:a.outlineUsesFillColor?k:q,opacity:n});e=e.getGeometry(b);this._processFeature(e,d,a.outlineUsesFillColor,l,r)}},
k.prototype._processFeature=function(b,a,f,c,g){if(b){var m=b.length;if(a&&(!f||!g||1==g.color[3]*g.opacity))for(a=0;a<m;a++)this._processOutline(b[a],g);var d;for(a=0;a<m;a++)g=k._area(b[a]),128<g?(void 0!==d&&this._processFill(b,d,c),d=[a]):-128>g&&void 0!==d&&d.push(a);void 0!==d&&this._processFill(b,d,c)}},k.prototype._processOutline=function(b,a){var f,c,g,m=this._outlineVertexBuffer,d=this._outlineIndexBuffer,k=d.index,q=new z.Point(0,0),n=new z.Point(0,0),p=new z.Point(0,0),h=-1,e=-1,l=-1,
r=-1,x=-1,A=!1,u=b.length;if(!(2>u)){for(var w=b[0],t=b[u-1];u&&t.isEqual(w);)--u,t=b[u-1];if(!(2>u-0)){for(w=0;w<u;++w){0===w?(f=b[u-1],c=b[0],g=b[1],q.assignSub(c,f),q.normalize(),q.rightPerpendicular()):(f=c,c=g,g=w!==u-1?b[w+1]:b[0],q.assign(n));t=this._isClipEdge(f,c);-1===r&&(A=t);n.assignSub(g,c);n.normalize();n.rightPerpendicular();var y=q.x*n.y-q.y*n.x;p.assignAdd(q,n);p.normalize();var v=-p.x*-q.x+-p.y*-q.y,v=Math.abs(0!==v?1/v:1);8<v&&(v=8);0<=y?(l=m.add(c.x,c.y,q.x,q.y,0,1,a),-1===r&&
(r=l),0<=h&&0<=e&&0<=l&&!t&&d.add(h,e,l),e=m.add(c.x,c.y,v*-p.x,v*-p.y,0,-1,a),-1===x&&(x=e),0<=h&&0<=e&&0<=l&&!t&&d.add(h,e,l),h=e,e=l,l=m.add(c.x,c.y,p.x,p.y,0,1,a),0<=h&&0<=e&&0<=l&&!t&&d.add(h,e,l),e=m.add(c.x,c.y,n.x,n.y,0,1,a),0<=h&&0<=e&&0<=l&&!t&&d.add(h,e,l)):(l=m.add(c.x,c.y,v*p.x,v*p.y,0,1,a),-1===r&&(r=l),0<=h&&0<=e&&0<=l&&!t&&d.add(h,e,l),e=m.add(c.x,c.y,-q.x,-q.y,0,-1,a),-1===x&&(x=e),0<=h&&0<=e&&0<=l&&!t&&d.add(h,e,l),h=e,e=l,l=m.add(c.x,c.y,-p.x,-p.y,0,-1,a),0<=h&&0<=e&&0<=l&&!t&&
d.add(h,e,l),0<=(h=m.add(c.x,c.y,-n.x,-n.y,0,-1,a))&&0<=e&&0<=l&&!t&&d.add(h,e,l))}0<=h&&0<=e&&0<=r&&!A&&d.add(h,e,r);0<=h&&0<=r&&0<=x&&!A&&d.add(h,x,r);this._outlineIndexCount+=3*(d.index-k)}}},k.prototype._processFill=function(b,a,f){var c;1<a.length&&(c=[]);for(var g=0,m=0;m<a.length;m++){var d=a[m];0!==g&&c.push(g);g+=b[d].length}for(var m=2*g,g=y.acquire(),k=0;k<a.length;k++)for(var d=a[k],d=b[d],q=d.length,n=0;n<q;++n)g.push(d[n].x),g.push(d[n].y);b=D(g,c,2);a=b.length;if(0<a){c=this._fillVertexBuffer.index;
for(k=0;k<m;)this._fillVertexBuffer.add(g[k++],g[k++],f);for(f=0;f<a;)this._fillIndexBuffer.add(c+b[f++],c+b[f++],c+b[f++]);this._fillIndexCount+=a}y.release(g)},k.prototype._isClipEdge=function(b,a){return b.x===a.x?-64>=b.x||4160<=b.x:b.y===a.y&&(-64>=b.y||4160<=b.y)},k._area=function(b){for(var a=0,f=b.length-1,c=0;c<f;c++)a+=(b[c].x-b[c+1].x)*(b[c].y+b[c+1].y);return.5*(a+=(b[f].x-b[0].x)*(b[f].y+b[0].y))},k}(E)});