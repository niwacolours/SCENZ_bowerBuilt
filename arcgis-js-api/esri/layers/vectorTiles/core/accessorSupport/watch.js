//>>built
define("require exports ../ArrayPool ../lang ../ObjectPool ../scheduling ./get ./utils ./wire".split(" "),function(E,f,z,q,A,B,h,l,r){function t(a){k.has(a)?c.splice(c.indexOf(a),1):k.add(a);c.push(a);m||(m=B.schedule(u))}function v(a){if(!a.removed){var e=a.callback,b=a.path,d=a.oldValue,c=a.target,n=h.valueOf(c,a.propertyPath,!0);!q.equals(d,n)&&(a.oldValue=n,e.call(c,n,d,b,c))}}function u(){if(m){m=null;var a=c;c=g.acquire();k.clear();for(var e=g.acquire(),b=0;b<a.length;b++){var d=a[b];v(d);d.removed&&
e.push(d)}for(b=0;b<c.length;b++)d=c[b],d.removed&&(e.push(d),k.delete(d),c.splice(b,1),--b);for(b=0;b<e.length;b++)w.pool.release(e[b]);g.release(a);g.release(e);p.forEach(function(a){return a()})}}function C(a,e,b){var d=l.parse(a,e,b,function(a,b,e){var c,f=h.valueOf(a,b,!0),x=r.wire(a,b,function(a,b){if(a.__accessor__.destroyed)return void d.remove();c||(c=w.pool.acquire(a,b,f,e),f=null);t(c)});return{remove:l.once(function(){x.remove();c&&(c.removed=!0,t(c),c=null);d=x=f=null})}});return d}function D(a,
e,b){var d=l.parse(a,e,b,function(a,b,e){var c=h.valueOf(a,b,!0),f=!1;return r.wire(a,b,function(a,b){if(a.__accessor__.destroyed)return void d.remove();if(!f){f=!0;var g=h.valueOf(a,b,!0);!q.equals(c,g)&&e.call(a,g,c,b,a);c=h.valueOf(a,b,!0);f=!1}})});return d}function y(a,c,b,d){return void 0===d&&(d=!1),!a.__accessor__||a.__accessor__.destroyed?{remove:function(){}}:d?D(a,c,b):C(a,c,b)}Object.defineProperty(f,"__esModule",{value:!0});var m,w=function(){function a(a,b,c,f){this.target=a;this.path=
b;this.oldValue=c;this.callback=f;this.removed=!1;this.propertyPath=l.pathToStringOrArray(b)}return a.prototype.release=function(){this.target=this.path=this.propertyPath=this.callback=this.oldValue=null;this.removed=!0},a.pool=new A(a,!0),a}(),g=new z,k=new Set,c=g.acquire();f.dispatchTarget=function(a){for(var e=g.copy(c),b=0;b<e.length;b++){var d=e[b];d.target===a&&(v(d),k.delete(d),c.splice(c.indexOf(d),1))}};f.removeTarget=function(a){for(var e=0;e<c.length;e++){var b=c[e];b.target===a&&(b.removed=
!0)}};f.dispatch=u;var p=new Set;f.afterDispatch=function(a){return p.add(a),{remove:function(){p.delete(a)}}};f.watch=y;f.isValueInUse=function(a){return c.some(function(c){return c.oldValue===a})};f.default=y});