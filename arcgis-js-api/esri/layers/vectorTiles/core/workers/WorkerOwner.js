//>>built
define("require exports dojo/Deferred ../../kernel ../Error ../Logger ../promiseUtils ./utils ./workerFactory".split(" "),function(z,A,m,n,p,q,r,d,t){var u=q.getLogger("esri.core.workers"),g=d.MessageType.CANCEL,v=d.MessageType.INVOKE,w=d.MessageType.OPEN,x=d.MessageType.OPENED,h=d.MessageType.RESPONSE;return function(){function b(a,c){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=c;a.addEventListener("message",this._onMessage.bind(this));a.addEventListener("error",function(a){a.preventDefault();
u.error(a)})}return b.create=function(a){return t.createWorker().then(function(c){return new b(c,a)})},b.prototype.terminate=function(){this.worker.terminate()},b.prototype.open=function(a){var c=this,f=d.newJobId(),b=new m(function(a){c._outJobs.delete(f);c._post({type:g,jobId:f})});return this._outJobs.set(f,b),this._post({type:w,jobId:f,modulePath:a}),b.promise},b.prototype._onMessage=function(a){if(a=d.receiveMessage(a))switch(a.type){case x:case h:this._onResponse(a);break;case g:this._onCancel(a);
break;case v:this._onInvoke(a)}},b.prototype._onCancel=function(a){(a=this._inJobs.get(a.jobId))&&a.cancel()},b.prototype._onInvoke=function(a){var c,b=this,k=a.methodName,e=a.jobId;a=a.data;var l=this._inJobs,g=n.workerMessages[k];try{if("function"!=typeof g)throw new TypeError(k+" is not a function");c=g.call(null,a)}catch(y){return void this._post({type:h,jobId:e,error:d.toInvokeError(y)})}r.isThenable(c)?(l.set(e,c),c.then(function(a){l.delete(e);b._post({type:h,jobId:e},a)}).catch(function(a){l.delete(e);
a||(a={message:"Error encountered at method"+k});a.dojoType&&"cancel"===a.dojoType||b._post({type:h,jobId:e,error:d.toInvokeError(a)})})):this._post({type:h,jobId:e},c)},b.prototype._onResponse=function(a){var c=a.jobId,b=a.error;a=a.data;var d=this._outJobs.get(c);d&&(this._outJobs.delete(c),b?d.reject(p.fromJSON(JSON.parse(b))):d.resolve(a))},b.prototype._post=function(a,b,f){return d.postMessage(this.worker,a,b,f)},b}()});