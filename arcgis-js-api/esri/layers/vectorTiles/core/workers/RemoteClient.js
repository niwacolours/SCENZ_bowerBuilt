//>>built
define("require exports dojo/Deferred ../Error ../promiseUtils ./utils".split(" "),function(z,A,q,r,t,e){var u=e.MessageType.CLOSE,h=e.MessageType.CANCEL,v=e.MessageType.INVOKE,k=e.MessageType.RESPONSE,w=e.MessageType.OPEN_PORT,x=function(){function b(a){this._timer=null;this._cancelledJobIds=new Set;this._invokeMessages=[];this._invoke=a;this._timer=null;this._process=this._process.bind(this)}return b.prototype.push=function(a){a.type===e.MessageType.CANCEL?this._cancelledJobIds.add(a.jobId):(this._invokeMessages.push(a),
null===this._timer&&(this._timer=setTimeout(this._process,0)))},b.prototype.clear=function(){this._invokeMessages.length=0;this._cancelledJobIds.clear();this._timer=null},b.prototype._process=function(){this._timer=null;for(var a=0,c=this._invokeMessages;a<c.length;a++){var f=c[a];this._cancelledJobIds.has(f.jobId)||this._invoke(f)}this._cancelledJobIds.clear();this._invokeMessages.length=0},b}();return function(){function b(a,c,f){this._outJobs=new Map;this._inJobs=new Map;this._queue=new x(this._onInvoke.bind(this));
this._onMessage=this._onMessage.bind(this);this._client=c;this._port=a;this._port.addEventListener("message",this._onMessage);this._port.start();this._channel=f}return b.connect=function(a){var c,f=new MessageChannel;return c="function"==typeof a?new a:"default"in a&&"function"==typeof a.default?new a.default:a,c.remoteClient=new b(f.port1,c,f),f.port2},b.prototype.close=function(){this._post({type:u});this._close()},b.prototype.isBusy=function(){return 0<this._outJobs.size},b.prototype.invoke=function(a,
c,f){var b=this;if(!this._port)return t.reject(new r("remote-client:port-closed","Can't invoke(), port is closed"));var d=e.newJobId(),g=new q(function(){b._outJobs.delete(d);b._post({type:h,jobId:d})});return this._outJobs.set(d,g),this._post({type:v,jobId:d,methodName:a},c,f),g.promise},b.prototype.openPort=function(){var a=this,c=e.newJobId(),f=new q(function(){a._outJobs.delete(c);a._post({type:h,jobId:c})});return this._outJobs.set(c,f),this._post({type:w,jobId:c}),f.promise},b.prototype._close=
function(){this._channel&&(this._channel=null);this._port.removeEventListener("message",this._onMessage);this._port.close();this._outJobs.forEach(function(a){a.cancel()});this._inJobs.clear();this._outJobs.clear();this._queue.clear();this._port=this._client=null},b.prototype._onMessage=function(a){if(a=e.receiveMessage(a))switch(a.type){case k:this._onResponse(a);break;case v:this._queue.push(a);break;case h:this._onCancel(a);break;case u:this._close();break;case w:this._onOpenPort(a)}},b.prototype._onCancel=
function(a){var c=this._inJobs,f=a.jobId,b=c.get(f);this._queue.push(a);b&&(c.delete(f),b.cancel())},b.prototype._onInvoke=function(a){var c,b=this,l=a.methodName,d=a.jobId;a=a.data;var g=this._inJobs,m=this._client,n=m[l];try{if(!n&&l&&-1!==l.indexOf("."))for(var h=l.split("."),p=0;p<h.length-1;p++)m=m[h[p]],n=m[h[p+1]];if("function"!=typeof n)throw new TypeError(l+" is not a function");c=n.call(m,a,this)}catch(y){return void this._post({type:k,jobId:d,error:e.toInvokeError(y)})}t.isThenable(c)?
(g.set(d,c),c.then(function(a){g.has(d)&&(g.delete(d),b._post({type:k,jobId:d},a))}).catch(function(a){g.has(d)&&(g.delete(d),a&&"cancel"===a.dojoType||b._post({type:k,jobId:d,error:e.toInvokeError(a||{message:"Error encountered at method "+l})}))})):this._post({type:k,jobId:d},c)},b.prototype._onOpenPort=function(a){var c=new MessageChannel;new b(c.port1,this._client);this._post({type:k,jobId:a.jobId},c.port2,[c.port2])},b.prototype._onResponse=function(a){var c=a.jobId,b=a.error;a=a.data;var e=
this._outJobs;if(e.has(c)){var d=e.get(c);e.delete(c);b?d.reject(r.fromJSON(JSON.parse(b))):d.resolve(a)}},b.prototype._post=function(a,c,b){return e.postMessage(this._port,a,c,b)},b}()});